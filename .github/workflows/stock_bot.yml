name: ËÇ°Á•®ÂàÜÊûêÊú∫Âô®‰∫∫ ü§ñ

# ============================================================================
# GitHub Repository Secrets ÈÖçÁΩÆËØ¥Êòé
# ============================================================================
# ËØ∑Âú® GitHub Repository Settings > Secrets and variables > Actions ‰∏≠ÈÖçÁΩÆ‰ª•‰∏ãÂèòÈáèÔºö
#
# 1. TELEGRAM_BOT_TOKEN
#    ËØ¥Êòé: Telegram Bot Token
#    Ëé∑ÂèñÊñπÂºè: ÈÄöËøá @BotFather ÂàõÂª∫Êú∫Âô®‰∫∫ÂêéËé∑Âèñ
#    Á§∫‰æã: 123456789:ABCdefGHIjklMNOpqrsTUVwxyz
#
# 2. TELEGRAM_CHAT_ID
#    ËØ¥Êòé: Telegram Chat IDÔºàÊé•Êî∂Ê∂àÊÅØÁöÑËÅäÂ§©IDÔºâ
#    Ëé∑ÂèñÊñπÂºè: ÈÄöËøá @userinfobot Êàñ @getidsbot Ëé∑Âèñ
#    Á§∫‰æã: 123456789
#
# 3. GDRIVE_CLIENT_ID, GDRIVE_CLIENT_SECRET, GDRIVE_REFRESH_TOKEN
#    ËØ¥Êòé: Google Drive OAuth Âá≠ËØÅÔºàÁî®‰∫é‰∏™‰∫∫Ë¥¶Âè∑ÊéàÊùÉ‰∏ä‰º†ÔºåÈÅøÂºÄÊúçÂä°Ë¥¶Âè∑ÈÖçÈ¢ùÈôêÂà∂Ôºâ
#    Ëé∑ÂèñÊñπÂºè:
#       a) Âú® Google Cloud Console ÂàõÂª∫ OAuth 2.0 ÂÆ¢Êà∑Á´Ø IDÔºàÂ∫îÁî®Á±ªÂûãÈÄâ "Ê°åÈù¢Â∫îÁî®"Ôºâ
#       b) Ëé∑Âèñ Client ID Âíå Client Secret
#       c) ‰ΩøÁî®ÊéàÊùÉÂ∑•ÂÖ∑Ëé∑Âèñ Refresh Token
#    Á§∫‰æã: 
#       GDRIVE_CLIENT_ID: 123456789-abc.apps.googleusercontent.com
#       GDRIVE_CLIENT_SECRET: GOCSPX-abc...
#       GDRIVE_REFRESH_TOKEN: 1//0abc...
#
# 4. GDRIVE_FOLDER_ID
#    ËØ¥Êòé: Google Drive ÁõÆÊ†áÊñá‰ª∂Â§π IDÔºàÊîØÊåÅÂçè‰Ωú‰∫ëÁ´ØÁ°¨ÁõòÊàñ‰∏™‰∫∫Êñá‰ª∂Â§πÔºâ
#    Ëé∑ÂèñÊñπÂºè: Âú® Drive ‰∏≠ÊâìÂºÄËØ•Êñá‰ª∂Â§πÔºå‰ªé URL ÁöÑ folders/xxx ÊèêÂèñ ID
#    Á§∫‰æã: 1a2b3c4d5e6f7g8h9i0j
#
# Ê≥®ÊÑè‰∫ãÈ°π:
# - Â∑≤ÂàáÊç¢Âà∞ OAuth ÊñπÊ°àÔºå‰∏çÂÜçÈúÄË¶Å GDRIVE_CREDENTIALS Âíå GDRIVE_OWNER_EMAIL
# - Êñá‰ª∂Â§πÈÖçÁΩÆÔºö
#     Âú®„ÄåÊàëÁöÑ‰∫ëÁ´ØÁ°¨Áõò„ÄçÂàõÂª∫Êñá‰ª∂Â§πÔºåÁ°Æ‰øùÊéàÊùÉË¥¶Âè∑ÊúâÊùÉËÆøÈóÆËØ•Êñá‰ª∂Â§π
#   ‚Üí Áî®ËØ•Êñá‰ª∂Â§π ID ‰Ωú‰∏∫ GDRIVE_FOLDER_ID
# - Á°Æ‰øùÂ∑≤ÂêØÁî® Google Drive API
# ============================================================================

on:
  schedule:
    # ‰∫§ÊòìÊó•ÂçàÁõò‰∏éÊî∂ÁõòÔºàÂåó‰∫¨Êó∂Èó¥Ôºâ
    # AËÇ°Ôºö11:30 / 15:00ÔºõÊ∏ØËÇ°Ôºö12:00 / 16:00
    # Ëß¶ÂèëÊó∂Èó¥Âä† 5 ÂàÜÈíüÁºìÂÜ≤
    - cron: '35 3 * * 1-5'  # 11:35
    - cron: '5 4 * * 1-5'   # 12:05
    - cron: '5 7 * * 1-5'   # 15:05
    - cron: '10 8 * * 1-5'  # 16:10
  workflow_dispatch:
    inputs:
      stocks:
        description: 'ËæìÂÖ•ËÇ°Á•®‰ª£Á†ÅÔºàÊîØÊåÅAËÇ°ÂíåÊ∏ØËÇ°ÔºåÂ¶ÇÔºö600460,00700Ôºâ'
        required: false
        default: '688630,600460,300474,300623,300019'

jobs:
  analyze-stocks:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
    - name: Ê£ÄÂá∫‰ª£Á†Å
      uses: actions/checkout@v4

    - name: ËÆæÁΩÆPythonÁéØÂ¢É
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ÂÆâË£Ö‰æùËµñ
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-core.txt -r requirements-optional.txt
        pip install pytz
        sudo apt-get update
        sudo apt-get install -y fonts-wqy-zenhei

    - name: ËøêË°åËÇ°Á•®ÂàÜÊûê
      id: run_analysis
      timeout-minutes: 25
      continue-on-error: true
      env:
        DATABASE_ENABLED: "false"
      run: |
        # ‰∏¥Êó∂Á¶ÅÁî®Êï∞ÊçÆÂ∫ìÔºöÊä•ÂëäÂè™Áî®Êé•Âè£ÂÆûÊó∂Êï∞ÊçÆÔºå‰∏çËØª‰∏çÂÜôÊú¨Âú∞ DB
        export TZ='Asia/Shanghai'
        # ËÆ∞ÂΩïËøêË°åÂºÄÂßãÊó∂Èó¥
        export RUN_START_TIME=$(date +%s)
        echo "RUN_START_TIME=$RUN_START_TIME" >> $GITHUB_ENV
        echo "ËøêË°åÂºÄÂßãÊó∂Èó¥: $(date) (Timestamp: $RUN_START_TIME)"
        
        STOCKS="${{ github.event.inputs.stocks }}"
        if [ -z "$STOCKS" ]; then
          STOCKS="688630,600460,300474,300623,300019"
        fi
        STOCKS="${STOCKS//,/ }"
        STOCKS="${STOCKS//Ôºå/ }"
        STOCKS="$(echo "$STOCKS" | xargs)"
        # ‰ΩøÁî® manual Ê®°ÂºèÔºåËøôÊ†∑ËÑöÊú¨Âè™ÁÆ°ÁîüÊàê PDFÔºå‰∏ç‰ºöÊä•Èîô‰πü‰∏ç‰ºöÈáçÂ§çÂèëÊ∂àÊÅØ
        python github_stock_bot.py --mode manual --stocks "$STOCKS"
        
        # Ê£ÄÊü•ÊòØÂê¶ÊúâPDFÊñá‰ª∂ÁîüÊàêÔºàÁõ¥Êé•ÁªüËÆ°PDFÊñá‰ª∂Ôºâ
        PDF_COUNT=$(python3 -c "
        import os
        import glob
        run_start = int(os.environ.get('RUN_START_TIME', 0))
        # Êü•ÊâæÊúÄÊñ∞Êä•ÂëäÊñá‰ª∂Â§π
        report_dirs = glob.glob('reports/reports_*')
        if not report_dirs:
            print(0)
            exit()
        latest_dir = max(report_dirs, key=os.path.getmtime)
        # Âè™ÁªüËÆ°Âú®ËøêË°åÂºÄÂßãÂêéÂàõÂª∫ÁöÑPDFÊñá‰ª∂ÔºàÂÖÅËÆ∏60ÁßíËØØÂ∑ÆÔºâ
        pdf_paths = glob.glob(os.path.join(latest_dir, '*.pdf'))
        pdf_paths = [p for p in pdf_paths if os.path.isfile(p) and os.path.getmtime(p) >= run_start - 60]
        print(len(pdf_paths))
        ")
        echo "Êú¨Ê¨°ËøêË°åÁîüÊàêÁöÑPDFÊï∞Èáè: $PDF_COUNT"
        echo "PDF_COUNT=$PDF_COUNT" >> $GITHUB_OUTPUT
        
        # ‰øùÂ≠òÊä•ÂëäÁõÆÂΩïË∑ØÂæÑ‰æõÂêéÁª≠Ê≠•È™§‰ΩøÁî®
        REPORT_DIR=$(python3 -c "
        import os
        import glob
        run_start = int(os.environ.get('RUN_START_TIME', 0))
        report_dirs = glob.glob('reports/reports_*')
        if report_dirs:
            latest_dir = max(report_dirs, key=os.path.getmtime)
            print(os.path.abspath(latest_dir))
        ")
        echo "REPORT_DIR=$REPORT_DIR" >> $GITHUB_ENV
        echo "Êä•ÂëäÁõÆÂΩï: $REPORT_DIR"
    
    - name: ÂèëÈÄÅÊä•ÂëäÂà∞ TelegramÔºàÂ§öÊñá‰ª∂Êé®ÈÄÅÔºâüöÄ
      if: steps.run_analysis.outcome == 'success' && steps.run_analysis.outputs.PDF_COUNT > 0
      run: |
        REPORT_DIR="${{ env.REPORT_DIR }}"
        if [ -z "$REPORT_DIR" ] || [ ! -d "$REPORT_DIR" ]; then
          echo "‚ùå Êä•ÂëäÁõÆÂΩï‰∏çÂ≠òÂú®: $REPORT_DIR"
          exit 1
        fi
        
        TELEGRAM_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
        TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
        
        if [ -z "$TELEGRAM_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
          echo "‚ùå TelegramÈÖçÁΩÆÁº∫Â§±ÔºåËØ∑Ê£ÄÊü•secrets: TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID"
          exit 1
        fi
        
        # ÁªüËÆ°PDFÊñá‰ª∂Êï∞Èáè
        PDF_FILES=("$REPORT_DIR"/*.pdf)
        PDF_COUNT=${#PDF_FILES[@]}
        
        if [ $PDF_COUNT -eq 0 ]; then
          echo "‚ö†Ô∏è Êú™ÊâæÂà∞PDFÊñá‰ª∂"
          exit 1
        fi
        
        echo "üì§ ÂºÄÂßãÂèëÈÄÅ $PDF_COUNT ‰∏™PDFÊñá‰ª∂Âà∞Telegram..."
        
        SUCCESS_COUNT=0
        FAIL_COUNT=0
        
        # Âæ™ÁéØÂèëÈÄÅÊØè‰∏™PDFÊñá‰ª∂
        for pdf_file in "$REPORT_DIR"/*.pdf; do
          if [ ! -f "$pdf_file" ]; then
            continue
          fi
          
          FILENAME=$(basename "$pdf_file")
          FILE_SIZE=$(stat -f%z "$pdf_file" 2>/dev/null || stat -c%s "$pdf_file" 2>/dev/null || echo "0")
          FILE_SIZE_MB=$((FILE_SIZE / 1024 / 1024))
          
          # Telegram Bot API Êñá‰ª∂Â§ßÂ∞èÈôêÂà∂‰∏∫ 50MB
          if [ $FILE_SIZE_MB -gt 50 ]; then
            echo "‚ö†Ô∏è Ë∑≥ËøáÊñá‰ª∂ $FILENAME (Â§ßÂ∞è: ${FILE_SIZE_MB}MBÔºåË∂ÖËøá50MBÈôêÂà∂)"
            FAIL_COUNT=$((FAIL_COUNT + 1))
            continue
          fi
          
          echo "üìÑ Ê≠£Âú®ÂèëÈÄÅ: $FILENAME (${FILE_SIZE_MB}MB)..."
          
          # ÂèëÈÄÅÊñá‰ª∂Âà∞Telegram
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -F "chat_id=$TELEGRAM_CHAT_ID" \
            -F "document=@$pdf_file" \
            "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendDocument" 2>&1)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ ÊàêÂäüÂèëÈÄÅ: $FILENAME"
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          else
            echo "‚ùå ÂèëÈÄÅÂ§±Ë¥•: $FILENAME (HTTP $HTTP_CODE)"
            echo "ÂìçÂ∫î: $BODY"
            FAIL_COUNT=$((FAIL_COUNT + 1))
          fi
          
          # ÈÅøÂÖçËØ∑Ê±ÇËøáÂø´ÔºåÊ∑ªÂä†Áü≠ÊöÇÂª∂Ëøü
          sleep 1
        done
        
        echo ""
        echo "üìä ÂèëÈÄÅÂÆåÊàêÁªüËÆ°:"
        echo "  ‚úÖ ÊàêÂäü: $SUCCESS_COUNT"
        echo "  ‚ùå Â§±Ë¥•: $FAIL_COUNT"
        echo "  üìÑ ÊÄªËÆ°: $PDF_COUNT"
        
        # ÂèëÈÄÅÂÆåÊàêÈÄöÁü•
        if [ $SUCCESS_COUNT -gt 0 ]; then
          curl -s -X POST \
            -F "chat_id=$TELEGRAM_CHAT_ID" \
            -F "text=‚úÖ FelixÔºåÊú∫Âô®‰∫∫Â∑≤ÂÆåÊàêËÇ°Á•®ÂàÜÊûêÊä•ÂëäÊé®ÈÄÅÔºàÊàêÂäü: $SUCCESS_COUNT/$PDF_COUNTÔºâ" \
            "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" > /dev/null
        fi
        
        # Â¶ÇÊûúÊúâÂ§±Ë¥•ÁöÑÊñá‰ª∂ÔºåÈÄÄÂá∫Á†Å‰∏∫1
        if [ $FAIL_COUNT -gt 0 ]; then
          exit 1
        fi

    - name: ‰∏ä‰º†Êä•ÂëäÂà∞ Google Drive üìÅ
      if: steps.run_analysis.outcome == 'success' && steps.run_analysis.outputs.PDF_COUNT > 0
      env:
        GDRIVE_CLIENT_ID: ${{ secrets.GDRIVE_CLIENT_ID }}
        GDRIVE_CLIENT_SECRET: ${{ secrets.GDRIVE_CLIENT_SECRET }}
        GDRIVE_REFRESH_TOKEN: ${{ secrets.GDRIVE_REFRESH_TOKEN }}
        GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        REPORT_DIR: ${{ env.REPORT_DIR }}
      run: |
        pip install -q google-auth google-api-python-client
        python - << 'PY'
        import os
        import json
        import glob
        from google.oauth2.credentials import Credentials
        from googleapiclient.discovery import build
        from googleapiclient.http import MediaFileUpload
        from googleapiclient.errors import HttpError

        report_dir = os.environ["REPORT_DIR"]
        client_id = os.environ.get("GDRIVE_CLIENT_ID", "").strip()
        client_secret = os.environ.get("GDRIVE_CLIENT_SECRET", "").strip()
        refresh_token = os.environ.get("GDRIVE_REFRESH_TOKEN", "").strip()
        folder_id = os.environ.get("GDRIVE_FOLDER_ID", "").strip()

        if not all([client_id, client_secret, refresh_token, folder_id]):
            raise SystemExit("Áº∫Â∞ë Google Drive OAuth ÈÖçÁΩÆ (CLIENT_ID, CLIENT_SECRET, REFRESH_TOKEN Êàñ FOLDER_ID)")

        # ‰ΩøÁî® Refresh Token ÊûÑÂª∫Âá≠ËØÅ
        creds = Credentials(
            None,
            refresh_token=refresh_token,
            token_uri="https://oauth2.googleapis.com/token",
            client_id=client_id,
            client_secret=client_secret,
            scopes=["https://www.googleapis.com/auth/drive.file"]
        )
        
        drive = build("drive", "v3", credentials=creds)

        # Ê†°È™åÊñá‰ª∂Â§π
        try:
            folder_info = drive.files().get(fileId=folder_id, fields="id,name", supportsAllDrives=True).execute()
            print(f"üìÅ ÁõÆÊ†áÊñá‰ª∂Â§π: {folder_info.get('name', folder_id)}")
        except Exception as e:
            raise SystemExit(f"Êó†Ê≥ïËÆøÈóÆ Google Drive Êñá‰ª∂Â§π: {e}\nËØ∑Ê£ÄÊü• GDRIVE_FOLDER_ID ÊòØÂê¶Ê≠£Á°ÆÔºå‰∏îÊéàÊùÉË¥¶Âè∑ÊúâÊùÉËÆøÈóÆ„ÄÇ")

        pdfs = sorted(glob.glob(os.path.join(report_dir, "*.pdf")))
        if not pdfs:
            raise SystemExit("Êú™ÊâæÂà∞ PDF Êñá‰ª∂")

        for path in pdfs:
            name = os.path.basename(path)
            meta = {"name": name, "parents": [folder_id]}
            media = MediaFileUpload(path, mimetype="application/pdf", resumable=True)
            try:
                f = drive.files().create(
                    body=meta,
                    media_body=media,
                    fields="id,name",
                    supportsAllDrives=True,
                ).execute()
                print(f"  ‚úÖ ‰∏ä‰º†ÊàêÂäü: {name} -> {f.get('id')}")
            except HttpError as e:
                print(f"  ‚ùå ‰∏ä‰º†Â§±Ë¥•: {name} (HTTP {e.resp.status})")
                print(f"  ÈîôËØØËØ¶ÊÉÖ: {e}")
                
        print(f"\nüìä ÂÖ±‰∏ä‰º† {len(pdfs)} ‰∏™Êñá‰ª∂")
        PY
