name: è‚¡ç¥¨åˆ†ææœºå™¨äºº ğŸ¤–

on:
Â  # 1. æ‰‹åŠ¨è§¦å‘ (ä¿®æ­£äº†è¿™é‡Œçš„ç¼©è¿›)
Â  workflow_dispatch:
Â  Â  inputs:
Â  Â  Â  stocks:
Â  Â  Â  Â  description: 'è‚¡ç¥¨ä»£ç ï¼ˆç©ºæ ¼åˆ†éš”ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤ï¼‰'
Â  Â  Â  Â  required: false
Â  Â  Â  Â  default: '600460 300474 300623 300420'
Â  Â  Â  Â  type: string
Â  Â  Â  telegram:
Â  Â  Â  Â  description: 'å‘é€åˆ°Telegram'
Â  Â  Â  Â  required: false
Â  Â  Â  Â  default: true
Â  Â  Â  Â  type: boolean
Â  Â  Â  force_run:
Â  Â  Â  Â  description: 'å¼ºåˆ¶è¿è¡Œï¼ˆå¿½ç•¥äº¤æ˜“æ—¶é—´æ£€æŸ¥ï¼‰'
Â  Â  Â  Â  required: false
Â  Â  Â  Â  default: false
Â  Â  Â  Â  type: boolean
Â Â 
Â  # 2. å®šæ—¶è§¦å‘ - Aè‚¡äº¤æ˜“æ—¶é—´ (ä¿®æ­£äº†è¿™é‡Œçš„ç¼©è¿›)
Â  schedule:
Â  Â  # æ¯30åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆåŒ—äº¬æ—¶é—´9:00-15:00 = UTC1:00-7:00ï¼‰
Â  Â  - cron: '*/30 1-7 * * 1-5'
Â  Â Â 
Â  Â  # æ¯å¤©æ”¶ç›˜åæ€»ç»“ï¼ˆåŒ—äº¬æ—¶é—´15:30 = UTC7:30ï¼‰
Â  Â  - cron: '30 7 * * 1-5'
Â  Â Â 
Â  Â  # æ¯å¤©å¼€ç›˜å‰å‡†å¤‡ï¼ˆåŒ—äº¬æ—¶é—´8:45 = UTC0:45ï¼‰
Â  Â  - cron: '45 0 * * 1-5'

jobs:
Â  analyze-stocks:
Â  Â  runs-on: ubuntu-latest
Â  Â  timeout-minutes: 20
Â  Â Â 
Â  Â  steps:
Â  Â  - name: æ£€å‡ºä»£ç 
Â  Â  Â  uses: actions/checkout@v3
Â  Â Â 
Â  Â  - name: è®¾ç½®Pythonç¯å¢ƒ
Â  Â  Â  uses: actions/setup-python@v4
Â  Â  Â  with:
Â  Â  Â  Â  python-version: '3.9'
Â  Â  Â  Â  cache: 'pip'
Â  Â Â 
Â  Â  - name: å®‰è£…ä¾èµ–
Â  Â  Â  run: |Â  # run å¿…é¡»å’Œ name å¯¹é½
Â  Â  Â  Â  python -m pip install --upgrade pip
Â  Â  Â  Â  pip install requests pandas numpy reportlab akshare matplotlib
Â  Â  Â  Â Â 
Â  Â  Â  Â  # å®‰è£…ä¸­æ–‡å­—ä½“æ”¯æŒ
Â  Â  Â  Â  sudo apt-get update
Â  Â  Â  Â  sudo apt-get install -y fonts-wqy-zenhei
Â  Â Â 
Â  Â  - name: è¿è¡Œè‚¡ç¥¨åˆ†æ
Â  Â  Â  env:
Â  Â  Â  Â  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
Â  Â  Â  Â  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
Â  Â  Â  run: |
Â  Â  Â  Â  echo "=========================================="
Â  Â  Â  Â  echo "ğŸ¤– GitHubè‚¡ç¥¨åˆ†ææœºå™¨äºº"
Â  Â  Â  Â  echo "=========================================="
Â  Â  Â  Â Â 
Â  Â  Â  Â  # è®¾ç½®ä¸­å›½æ—¶åŒº
Â  Â  Â  Â  export TZ='Asia/Shanghai'
Â  Â  Â  Â  echo "ğŸ• å½“å‰æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
Â  Â  Â  Â  echo ""
Â  Â  Â  Â Â 
Â  Â  Â  Â  # æ£€æŸ¥æ˜¯å¦ä¸ºå®šæ—¶ä»»åŠ¡ä¸”éœ€è¦æ£€æŸ¥äº¤æ˜“æ—¶é—´
Â  Â  Â  Â  if [[ "${{ github.event_name }}" == "schedule" && "${{ github.event.inputs.force_run }}" != "true" ]]; then
Â  Â  Â  Â  Â  echo "ğŸ“… å®šæ—¶ä»»åŠ¡æ‰§è¡Œæ£€æŸ¥..."
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  # æ£€æŸ¥æ˜¯å¦ä¸ºAè‚¡äº¤æ˜“æ—¥
Â  Â  Â  Â  Â  CURRENT_WEEKDAY=$(date +%u)Â  # 1=å‘¨ä¸€, 7=å‘¨æ—¥
Â  Â  Â  Â  Â  CURRENT_HOUR=$(date +%H)
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  echo "Â  æ˜ŸæœŸ: $CURRENT_WEEKDAY"
Â  Â  Â  Â  Â  echo "Â  æ—¶é—´: $CURRENT_HOUR:$(date +%M)"
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  # æ£€æŸ¥æ˜¯å¦ä¸ºäº¤æ˜“æ—¥
Â  Â  Â  Â  Â  if [[ $CURRENT_WEEKDAY -ge 1 && $CURRENT_WEEKDAY -le 5 ]]; then
Â  Â  Â  Â  Â  Â  # æ£€æŸ¥æ˜¯å¦ä¸ºäº¤æ˜“æ—¶é—´
Â  Â  Â  Â  Â  Â  if [[ $CURRENT_HOUR -ge 9 && $CURRENT_HOUR -lt 15 ]]; then
Â  Â  Â  Â  Â  Â  Â  echo "âœ… æ£€æµ‹åˆ°Aè‚¡äº¤æ˜“æ—¶é—´ï¼Œç»§ç»­æ‰§è¡Œ..."
Â  Â  Â  Â  Â  Â  Â  CHECK_HOURS_FLAG="--check-hours"
Â  Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  Â  echo "â¸ï¸Â  éäº¤æ˜“æ—¶é—´ï¼Œè·³è¿‡æ‰§è¡Œ"
Â  Â  Â  Â  Â  Â  Â  exit 0
Â  Â  Â  Â  Â  Â  fi
Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  echo "â¸ï¸Â  éäº¤æ˜“æ—¥ï¼Œè·³è¿‡æ‰§è¡Œ"
Â  Â  Â  Â  Â  Â  exit 0
Â  Â  Â  Â  Â  fi
Â  Â  Â  Â  else
Â  Â  Â  Â  Â  echo "ğŸ”§ æ‰‹åŠ¨è§¦å‘æˆ–å¼ºåˆ¶è¿è¡Œï¼Œè·³è¿‡æ—¶é—´æ£€æŸ¥"
Â  Â  Â  Â  Â  CHECK_HOURS_FLAG=""
Â  Â  Â  Â  fi
Â  Â  Â  Â Â 
Â  Â  Â  Â  # æ„å»ºè¿è¡Œå‘½ä»¤
Â  Â  Â  Â  CMD="python github_stock_bot.py"
Â  Â  Â  Â Â 
Â  Â  Â  Â  # æ·»åŠ è‚¡ç¥¨ä»£ç 
Â  Â  Â  Â  if [[ -n "${{ github.event.inputs.stocks }}" ]]; then
Â  Â  Â  Â  Â  echo "ğŸ“ ä½¿ç”¨æŒ‡å®šè‚¡ç¥¨: ${{ github.event.inputs.stocks }}"
Â  Â  Â  Â  Â  CMD="$CMD --stocks '${{ github.event.inputs.stocks }}'"
Â  Â  Â  Â  else
Â  Â  Â  Â  Â  echo "ğŸ“ ä½¿ç”¨é»˜è®¤è‚¡ç¥¨"
Â  Â  Â  Â  fi
Â  Â  Â  Â Â 
Â  Â  Â  Â  # æ·»åŠ Telegramå‚æ•°
Â  Â  Â  Â  if [[ "${{ github.event.inputs.telegram }}" == "true" || "${{ github.event_name }}" == "schedule" ]]; then
Â  Â  Â  Â  Â  echo "ğŸ¤– å¯ç”¨Telegramé€šçŸ¥"
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  # æ£€æŸ¥é…ç½®
Â  Â  Â  Â  Â  if [[ -z "$TELEGRAM_BOT_TOKEN" || -z "$TELEGRAM_CHAT_ID" ]]; then
Â  Â  Â  Â  Â  Â  echo "âš ï¸Â  Telegramé…ç½®ä¸å®Œæ•´"
Â  Â  Â  Â  Â  Â  echo "Â  Â è¯·æ£€æŸ¥GitHub Secretsè®¾ç½®"
Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  CMD="$CMD --telegram"
Â  Â  Â  Â  Â  fi
Â  Â  Â  Â  else
Â  Â  Â  Â  Â  echo "ğŸ”• ç¦ç”¨Telegramé€šçŸ¥"
Â  Â  Â  Â  fi
Â  Â  Â  Â Â 
Â  Â  Â  Â  # æ·»åŠ æ—¶é—´æ£€æŸ¥å‚æ•°
Â  Â  Â  Â  if [[ -n "$CHECK_HOURS_FLAG" ]]; then
Â  Â  Â  Â  Â  CMD="$CMD $CHECK_HOURS_FLAG"
Â  Â  Â  Â  fi
Â  Â  Â  Â Â 
Â  Â  Â  Â  echo ""
Â  Â  Â  Â  echo "ğŸš€ æ‰§è¡Œå‘½ä»¤: $CMD"
Â  Â  Â  Â  echo "=========================================="
Â  Â  Â  Â Â 
Â  Â  Â  Â  # æ‰§è¡Œåˆ†æ
Â  Â  Â  Â  eval $CMD
Â  Â  Â  Â Â 
Â  Â  Â  Â  EXIT_CODE=$?
Â  Â  Â  Â Â 
Â  Â  Â  Â  echo ""
Â  Â  Â  Â  echo "=========================================="
Â  Â  Â  Â  if [[ $EXIT_CODE -eq 0 ]]; then
Â  Â  Â  Â  Â  echo "ğŸ‰ è‚¡ç¥¨åˆ†æä»»åŠ¡å®Œæˆ"
Â  Â  Â  Â  else
Â  Â  Â  Â  Â  echo "âŒ è‚¡ç¥¨åˆ†æä»»åŠ¡å¤±è´¥"
Â  Â  Â  Â  Â  exit $EXIT_CODE
Â  Â  Â  Â  fi
Â  Â Â 
Â  Â  - name: ä¸Šä¼ åˆ†ææŠ¥å‘Š
Â  Â  Â  if: always()
Â  Â  Â  uses: actions/upload-artifact@v3
Â  Â  Â  with:
Â  Â  Â  Â  name: stock-reports-${{ github.run_id }}
Â  Â  Â  Â  path: |
Â  Â  Â  Â  Â  reports_*
Â  Â  Â  Â  Â  *.zip
Â  Â  Â  Â  retention-days: 30
Â  Â Â 
Â  Â  - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
Â  Â  Â  if: always()
Â  Â  Â  run: |
Â  Â  Â  Â  echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
Â  Â  Â  Â  rm -rf reports_* *.zip 2>/dev/null || true
Â  Â Â 
Â  Â  - name: å‘é€å¤±è´¥é€šçŸ¥åˆ°Telegram
Â  Â  Â  if: failure()
Â  Â  Â  uses: appleboy/telegram-action@master
Â  Â  Â  with:
Â  Â  Â  Â  to: ${{ secrets.TELEGRAM_CHAT_ID }}
Â  Â  Â  Â  token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
Â  Â  Â  Â  message: |
Â  Â  Â  Â  Â  âŒ è‚¡ç¥¨åˆ†æä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  å·¥ä½œæµ: ${{ github.workflow }}
Â  Â  Â  Â  Â  è¿è¡ŒID: ${{ github.run_id }}
Â  Â  Â  Â  Â  è§¦å‘æ–¹å¼: ${{ github.event_name }}
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  è¯·æ£€æŸ¥æ—¥å¿—: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}