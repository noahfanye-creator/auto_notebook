name: è‚¡ç¥¨åˆ†ææœºå™¨äºº ğŸ¤–

on:
  schedule:
    # äº¤æ˜“æ—¥åˆç›˜ä¸æ”¶ç›˜ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
    # Aè‚¡ï¼š11:30 / 15:00ï¼›æ¸¯è‚¡ï¼š12:00 / 16:00
    # è§¦å‘æ—¶é—´åŠ  5 åˆ†é’Ÿç¼“å†²
    - cron: '35 3 * * 1-5'  # 11:35
    - cron: '5 4 * * 1-5'   # 12:05
    - cron: '5 7 * * 1-5'   # 15:05
    - cron: '10 8 * * 1-5'  # 16:10
  workflow_dispatch:
    inputs:
      stocks:
        description: 'è¾“å…¥è‚¡ç¥¨ä»£ç ï¼ˆæ”¯æŒAè‚¡å’Œæ¸¯è‚¡ï¼Œå¦‚ï¼š600460,00700ï¼‰'
        required: false
        default: '688630,600460,300474,300623,300019'

jobs:
  analyze-stocks:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-core.txt -r requirements-optional.txt
        pip install pytz
        sudo apt-get update
        sudo apt-get install -y fonts-wqy-zenhei

    - name: è¿è¡Œè‚¡ç¥¨åˆ†æ
      id: run_analysis
      timeout-minutes: 25
      continue-on-error: true
      run: |
        export TZ='Asia/Shanghai'
        # è®°å½•è¿è¡Œå¼€å§‹æ—¶é—´
        export RUN_START_TIME=$(date +%s)
        echo "RUN_START_TIME=$RUN_START_TIME" >> $GITHUB_ENV
        echo "è¿è¡Œå¼€å§‹æ—¶é—´: $(date) (Timestamp: $RUN_START_TIME)"
        
        STOCKS="${{ github.event.inputs.stocks }}"
        if [ -z "$STOCKS" ]; then
          STOCKS="688630,600460,300474,300623,300019"
        fi
        STOCKS="${STOCKS//,/ }"
        STOCKS="${STOCKS//ï¼Œ/ }"
        STOCKS="$(echo "$STOCKS" | xargs)"
        # ä½¿ç”¨ manual æ¨¡å¼ï¼Œè¿™æ ·è„šæœ¬åªç®¡ç”Ÿæˆ PDFï¼Œä¸ä¼šæŠ¥é”™ä¹Ÿä¸ä¼šé‡å¤å‘æ¶ˆæ¯
        python github_stock_bot.py --mode manual --stocks "$STOCKS"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰PDFæ–‡ä»¶ç”Ÿæˆï¼ˆä»¥æœ¬æ¬¡ZIPä¸ºå‡†ï¼Œé¿å…è¯¯è®¡ï¼‰
        PDF_COUNT=$(python3 -c "
        import os
        import glob
        import zipfile
        run_start = int(os.environ.get('RUN_START_TIME', 0))
        # æŸ¥æ‰¾æœ€æ–°æŠ¥å‘Šæ–‡ä»¶å¤¹
        report_dirs = glob.glob('reports/reports_*')
        if not report_dirs:
            print(0)
            exit()
        latest_dir = max(report_dirs, key=os.path.getmtime)
        zip_paths = glob.glob(os.path.join(latest_dir, 'stock_reports_*.zip'))
        if not zip_paths:
            print(0)
            exit()
        zip_paths.sort(key=os.path.getmtime, reverse=True)
        zip_path = zip_paths[0]
        # ç»Ÿè®¡ ZIP å†… PDF æ•°é‡
        with zipfile.ZipFile(zip_path, 'r') as zf:
            pdfs = [name for name in zf.namelist() if name.lower().endswith('.pdf')]
        print(len(pdfs))
        ")
        echo "æœ¬æ¬¡è¿è¡Œç”Ÿæˆçš„PDFæ•°é‡: $PDF_COUNT"
        echo "PDF_COUNT=$PDF_COUNT" >> $GITHUB_OUTPUT
    
    - name: æ•´ç†æŠ¥å‘Šæ–‡ä»¶
      if: steps.run_analysis.outcome == 'success' && steps.run_analysis.outputs.PDF_COUNT > 0
      run: |
        mkdir -p final_delivery
        
        # ç­‰å¾…ä¸€ä¸‹ï¼Œç¡®ä¿ZIPæ–‡ä»¶æœ‰æ—¶é—´ç”Ÿæˆ
        sleep 2
        
        # é€‰æ‹©æœ¬æ¬¡è¿è¡Œç”Ÿæˆçš„æœ€æ–° ZIPï¼ˆåˆ›å»ºæ—¶é—´åœ¨è¿è¡Œå¼€å§‹ä¹‹åï¼‰
        ZIP_PATH=$(python -c "
        import glob
        import os
        import sys
        run_start = int('${{ env.RUN_START_TIME }}')
        paths = glob.glob('reports/**/stock_reports_*.zip', recursive=True)
        paths = [p for p in paths if os.path.isfile(p)]
        # åªé€‰æ‹©åœ¨è¿è¡Œå¼€å§‹ååˆ›å»ºçš„ZIPæ–‡ä»¶ï¼ˆå…è®¸60ç§’è¯¯å·®ï¼‰
        paths = [p for p in paths if os.path.getmtime(p) >= run_start - 60]
        if paths:
            paths.sort(key=lambda p: os.path.getmtime(p), reverse=True)
            print(paths[0])
        ")
        
        if [ -z "$ZIP_PATH" ] || [ ! -f "$ZIP_PATH" ]; then
          echo "âŒ æœªæ‰¾åˆ°æœ¬æ¬¡è¿è¡Œç”Ÿæˆçš„æŠ¥å‘Š ZIP"
          echo "æ£€æŸ¥ reports ç›®å½•:"
          ls -la reports/*/stock_reports_*.zip 2>/dev/null || echo "æœªæ‰¾åˆ°ZIPæ–‡ä»¶"
          echo "è¿è¡Œå¼€å§‹æ—¶é—´æˆ³: ${{ env.RUN_START_TIME }}"
          echo "å½“å‰æ—¶é—´æˆ³: $(date +%s)"
          exit 1
        fi
        
        # éªŒè¯ZIPæ–‡ä»¶å¤§å°ï¼ˆè‡³å°‘åº”è¯¥æœ‰ä¸€äº›å†…å®¹ï¼‰
        ZIP_SIZE=$(stat -f%z "$ZIP_PATH" 2>/dev/null || stat -c%s "$ZIP_PATH" 2>/dev/null || echo "0")
        if [ "$ZIP_SIZE" -lt 1000 ]; then
          echo "âš ï¸ ZIPæ–‡ä»¶å¤ªå° ($ZIP_SIZE å­—èŠ‚)ï¼Œå¯èƒ½ä¸å®Œæ•´"
          exit 1
        fi
        
        echo "âœ… ä½¿ç”¨æŠ¥å‘ŠZIP: $ZIP_PATH (å¤§å°: $ZIP_SIZE å­—èŠ‚)"
        # æå–åŸå§‹æ–‡ä»¶åä¸­çš„æ—¶é—´æˆ³ï¼Œæˆ–ç”Ÿæˆæ–°çš„æ—¶é—´æˆ³
        ZIP_BASENAME=$(basename "$ZIP_PATH")
        # å¦‚æœæ–‡ä»¶ååŒ…å«æ—¶é—´æˆ³ï¼Œä¿ç•™å®ƒï¼›å¦åˆ™ç”Ÿæˆæ–°çš„æ—¶é—´æˆ³
        if [[ "$ZIP_BASENAME" =~ stock_reports_([0-9]{8}_[0-9]{6})\.zip ]]; then
          TIMESTAMP="${BASH_REMATCH[1]}"
        else
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        fi
        ZIP_FILENAME="stock_reports_${TIMESTAMP}.zip"
        cp "$ZIP_PATH" "final_delivery/${ZIP_FILENAME}"
        echo "ZIP_FILENAME=${ZIP_FILENAME}" >> $GITHUB_ENV

    - name: ä¸Šä¼ æŠ¥å‘Šåˆ° GitHub Artifact
      if: steps.run_analysis.outcome == 'success' && steps.run_analysis.outputs.PDF_COUNT > 0
      uses: actions/upload-artifact@v4
      with:
        name: stock-reports-${{ github.run_id }}
        path: |
          final_delivery/stock_reports_*.zip

    - name: å‘é€æŠ¥å‘Šåˆ° Telegram ğŸš€
      if: steps.run_analysis.outcome == 'success' && steps.run_analysis.outputs.PDF_COUNT > 0
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        document: final_delivery/${{ env.ZIP_FILENAME }}
        message: "âœ… Felixï¼Œæœºå™¨äººå·²å®Œæˆè‚¡ç¥¨åˆ†ææŠ¥å‘Šï¼ˆZIPï¼‰"
