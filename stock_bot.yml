name: è‚¡ç¥¨åˆ†ææœºå™¨äºº ğŸ¤–

on:
  # 1. æ‰‹åŠ¨è§¦å‘ (ä¿®æ­£äº†è¿™é‡Œçš„ç¼©è¿›)
  workflow_dispatch:
    inputs:
      stocks:
        description: 'è‚¡ç¥¨ä»£ç ï¼ˆç©ºæ ¼åˆ†éš”ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤ï¼‰'
        required: false
        default: '600460 300474 300623 300420'
        type: string
      telegram:
        description: 'å‘é€åˆ°Telegram'
        required: false
        default: true
        type: boolean
      force_run:
        description: 'å¼ºåˆ¶è¿è¡Œï¼ˆå¿½ç•¥äº¤æ˜“æ—¶é—´æ£€æŸ¥ï¼‰'
        required: false
        default: false
        type: boolean
  
  # 2. å®šæ—¶è§¦å‘ - Aè‚¡äº¤æ˜“æ—¶é—´ (ä¿®æ­£äº†è¿™é‡Œçš„ç¼©è¿›)
  schedule:
    # æ¯30åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆåŒ—äº¬æ—¶é—´9:00-15:00 = UTC1:00-7:00ï¼‰
    - cron: '*/30 1-7 * * 1-5'
    
    # æ¯å¤©æ”¶ç›˜åæ€»ç»“ï¼ˆåŒ—äº¬æ—¶é—´15:30 = UTC7:30ï¼‰
    - cron: '30 7 * * 1-5'
    
    # æ¯å¤©å¼€ç›˜å‰å‡†å¤‡ï¼ˆåŒ—äº¬æ—¶é—´8:45 = UTC0:45ï¼‰
    - cron: '45 0 * * 1-5'

jobs:
  analyze-stocks:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: å®‰è£…ä¾èµ–
     run: |
        python -m pip install --upgrade pip
        pip install requests pandas numpy reportlab akshare matplotlib
        
        # å®‰è£…ä¸­æ–‡å­—ä½“æ”¯æŒ
        sudo apt-get update
        sudo apt-get install -y fonts-wqy-zenhei
    
    - name: è¿è¡Œè‚¡ç¥¨åˆ†æ
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        echo "=========================================="
        echo "ğŸ¤– GitHubè‚¡ç¥¨åˆ†ææœºå™¨äºº"
        echo "=========================================="
        
        # è®¾ç½®ä¸­å›½æ—¶åŒº
        export TZ='Asia/Shanghai'
        echo "ğŸ• å½“å‰æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
        echo ""
        
        # æ£€æŸ¥æ˜¯å¦ä¸ºå®šæ—¶ä»»åŠ¡ä¸”éœ€è¦æ£€æŸ¥äº¤æ˜“æ—¶é—´
        if [[ "${{ github.event_name }}" == "schedule" && "${{ github.event.inputs.force_run }}" != "true" ]]; then
          echo "ğŸ“… å®šæ—¶ä»»åŠ¡æ‰§è¡Œæ£€æŸ¥..."
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºAè‚¡äº¤æ˜“æ—¥
          CURRENT_WEEKDAY=$(date +%u)  # 1=å‘¨ä¸€, 7=å‘¨æ—¥
          CURRENT_HOUR=$(date +%H)
          
          echo "  æ˜ŸæœŸ: $CURRENT_WEEKDAY"
          echo "  æ—¶é—´: $CURRENT_HOUR:$(date +%M)"
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºäº¤æ˜“æ—¥
          if [[ $CURRENT_WEEKDAY -ge 1 && $CURRENT_WEEKDAY -le 5 ]]; then
            # æ£€æŸ¥æ˜¯å¦ä¸ºäº¤æ˜“æ—¶é—´
            if [[ $CURRENT_HOUR -ge 9 && $CURRENT_HOUR -lt 15 ]]; then
              echo "âœ… æ£€æµ‹åˆ°Aè‚¡äº¤æ˜“æ—¶é—´ï¼Œç»§ç»­æ‰§è¡Œ..."
              CHECK_HOURS_FLAG="--check-hours"
            else
              echo "â¸ï¸  éäº¤æ˜“æ—¶é—´ï¼Œè·³è¿‡æ‰§è¡Œ"
              exit 0
            fi
          else
            echo "â¸ï¸  éäº¤æ˜“æ—¥ï¼Œè·³è¿‡æ‰§è¡Œ"
            exit 0
          fi
        else
          echo "ğŸ”§ æ‰‹åŠ¨è§¦å‘æˆ–å¼ºåˆ¶è¿è¡Œï¼Œè·³è¿‡æ—¶é—´æ£€æŸ¥"
          CHECK_HOURS_FLAG=""
        fi
        
        # æ„å»ºè¿è¡Œå‘½ä»¤
        CMD="python github_stock_bot.py"
        
        # æ·»åŠ è‚¡ç¥¨ä»£ç 
        if [[ -n "${{ github.event.inputs.stocks }}" ]]; then
          echo "ğŸ“ ä½¿ç”¨æŒ‡å®šè‚¡ç¥¨: ${{ github.event.inputs.stocks }}"
          CMD="$CMD --stocks '${{ github.event.inputs.stocks }}'"
        else
          echo "ğŸ“ ä½¿ç”¨é»˜è®¤è‚¡ç¥¨"
        fi
        
        # æ·»åŠ Telegramå‚æ•°
        if [[ "${{ github.event.inputs.telegram }}" == "true" || "${{ github.event_name }}" == "schedule" ]]; then
          echo "ğŸ¤– å¯ç”¨Telegramé€šçŸ¥"
          
          # æ£€æŸ¥é…ç½®
          if [[ -z "$TELEGRAM_BOT_TOKEN" || -z "$TELEGRAM_CHAT_ID" ]]; then
            echo "âš ï¸  Telegramé…ç½®ä¸å®Œæ•´"
            echo "   è¯·æ£€æŸ¥GitHub Secretsè®¾ç½®"
          else
            CMD="$CMD --telegram"
          fi
        else
          echo "ğŸ”• ç¦ç”¨Telegramé€šçŸ¥"
        fi
        
        # æ·»åŠ æ—¶é—´æ£€æŸ¥å‚æ•°
        if [[ -n "$CHECK_HOURS_FLAG" ]]; then
          CMD="$CMD $CHECK_HOURS_FLAG"
        fi
        
        echo ""
        echo "ğŸš€ æ‰§è¡Œå‘½ä»¤: $CMD"
        echo "=========================================="
        
        # æ‰§è¡Œåˆ†æ
        eval $CMD
        
        EXIT_CODE=$?
        
        echo ""
        echo "=========================================="
        if [[ $EXIT_CODE -eq 0 ]]; then
          echo "ğŸ‰ è‚¡ç¥¨åˆ†æä»»åŠ¡å®Œæˆ"
        else
          echo "âŒ è‚¡ç¥¨åˆ†æä»»åŠ¡å¤±è´¥"
          exit $EXIT_CODE
        fi
    
    - name: ä¸Šä¼ åˆ†ææŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: stock-reports-${{ github.run_id }}
        path: |
          reports_*
          *.zip
        retention-days: 30
    
    - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        rm -rf reports_* *.zip 2>/dev/null || true
    
    - name: å‘é€å¤±è´¥é€šçŸ¥åˆ°Telegram
      if: failure()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          âŒ è‚¡ç¥¨åˆ†æä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼
          
          å·¥ä½œæµ: ${{ github.workflow }}
          è¿è¡ŒID: ${{ github.run_id }}
          è§¦å‘æ–¹å¼: ${{ github.event_name }}
          
          è¯·æ£€æŸ¥æ—¥å¿—: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
