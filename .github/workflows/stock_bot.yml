name: è‚¡ç¥¨åˆ†æžæœºå™¨äºº ðŸ¤–

# ============================================================================
# GitHub Repository Secrets é…ç½®è¯´æ˜Ž
# ============================================================================
# è¯·åœ¨ GitHub Repository Settings > Secrets and variables > Actions ä¸­é…ç½®ä»¥ä¸‹å˜é‡ï¼š
#
# 1. TELEGRAM_BOT_TOKEN
#    è¯´æ˜Ž: Telegram Bot Token
#    èŽ·å–æ–¹å¼: é€šè¿‡ @BotFather åˆ›å»ºæœºå™¨äººåŽèŽ·å–
#    ç¤ºä¾‹: 123456789:ABCdefGHIjklMNOpqrsTUVwxyz
#
# 2. TELEGRAM_CHAT_ID
#    è¯´æ˜Ž: Telegram Chat IDï¼ˆæŽ¥æ”¶æ¶ˆæ¯çš„èŠå¤©IDï¼‰
#    èŽ·å–æ–¹å¼: é€šè¿‡ @userinfobot æˆ– @getidsbot èŽ·å–
#    ç¤ºä¾‹: 123456789
#
# 3. GDRIVE_CREDENTIALS
#    è¯´æ˜Ž: Google Drive æœåŠ¡è´¦å· JSON å‡­è¯ï¼Œå¿…é¡»æ˜¯ base64 ç¼–ç åŽçš„æ•´æ®µå­—ç¬¦ä¸²ï¼ˆä¸èƒ½å­˜åŽŸå§‹ JSONï¼‰
#    èŽ·å–æ–¹å¼:
#       a) åœ¨ Google Cloud Console åˆ›å»ºæœåŠ¡è´¦å·ï¼Œä¸‹è½½ JSON å¯†é’¥æ–‡ä»¶
#       b) åœ¨ç»ˆç«¯æ‰§è¡Œç¼–ç ï¼ˆä»»é€‰å…¶ä¸€ï¼Œè¾“å‡ºä¸ºå•è¡Œæ— æ¢è¡Œï¼‰:
#          Linux:   base64 -w 0 credentials.json
#          macOS:   base64 -i credentials.json | tr -d '\n'
#       c) å°†å®Œæ•´è¾“å‡ºç²˜è´´åˆ° GDRIVE_CREDENTIALSï¼Œä¸è¦åŠ å¼•å·ã€ä¸è¦æ¢è¡Œ
#    è‹¥æŠ¥é”™ "illegal base64 data at input byte 0"ï¼Œè¯´æ˜Žå­˜çš„æ˜¯åŽŸå§‹ JSONï¼Œè¯·æŒ‰ä¸Šè¿°æ­¥éª¤é‡æ–° base64 åŽä¿å­˜
#    ç¤ºä¾‹: eyJ0eXBlIjoic2VydmljZV9hY2NvdW50Ii...
#
# 4. GDRIVE_FOLDER_ID
#    è¯´æ˜Ž: Google Drive ç›®æ ‡æ–‡ä»¶å¤¹ ID
#    èŽ·å–æ–¹å¼: åœ¨ Google Drive ä¸­æ‰“å¼€ç›®æ ‡æ–‡ä»¶å¤¹ï¼Œä»ŽURLä¸­æå–ID
#    ç¤ºä¾‹: 1a2b3c4d5e6f7g8h9i0j
#
# æ³¨æ„äº‹é¡¹:
# - GDRIVE_CREDENTIALS å¿…é¡»æ˜¯ base64 ç¼–ç çš„å®Œæ•´ JSON å†…å®¹
# - Google Drive æ–‡ä»¶å¤¹éœ€è¦ä¸ŽæœåŠ¡è´¦å·é‚®ç®±å…±äº«ï¼ˆåœ¨æ–‡ä»¶å¤¹è®¾ç½®ä¸­ï¼‰
# - ç¡®ä¿æœåŠ¡è´¦å·å·²å¯ç”¨ Google Drive API
# ============================================================================

on:
  schedule:
    # äº¤æ˜“æ—¥åˆç›˜ä¸Žæ”¶ç›˜ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
    # Aè‚¡ï¼š11:30 / 15:00ï¼›æ¸¯è‚¡ï¼š12:00 / 16:00
    # è§¦å‘æ—¶é—´åŠ  5 åˆ†é’Ÿç¼“å†²
    - cron: '35 3 * * 1-5'  # 11:35
    - cron: '5 4 * * 1-5'   # 12:05
    - cron: '5 7 * * 1-5'   # 15:05
    - cron: '10 8 * * 1-5'  # 16:10
  workflow_dispatch:
    inputs:
      stocks:
        description: 'è¾“å…¥è‚¡ç¥¨ä»£ç ï¼ˆæ”¯æŒAè‚¡å’Œæ¸¯è‚¡ï¼Œå¦‚ï¼š600460,00700ï¼‰'
        required: false
        default: '688630,600460,300474,300623,300019'

jobs:
  analyze-stocks:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-core.txt -r requirements-optional.txt
        pip install pytz
        sudo apt-get update
        sudo apt-get install -y fonts-wqy-zenhei

    - name: è¿è¡Œè‚¡ç¥¨åˆ†æž
      id: run_analysis
      timeout-minutes: 25
      continue-on-error: true
      run: |
        export TZ='Asia/Shanghai'
        # è®°å½•è¿è¡Œå¼€å§‹æ—¶é—´
        export RUN_START_TIME=$(date +%s)
        echo "RUN_START_TIME=$RUN_START_TIME" >> $GITHUB_ENV
        echo "è¿è¡Œå¼€å§‹æ—¶é—´: $(date) (Timestamp: $RUN_START_TIME)"
        
        STOCKS="${{ github.event.inputs.stocks }}"
        if [ -z "$STOCKS" ]; then
          STOCKS="688630,600460,300474,300623,300019"
        fi
        STOCKS="${STOCKS//,/ }"
        STOCKS="${STOCKS//ï¼Œ/ }"
        STOCKS="$(echo "$STOCKS" | xargs)"
        # ä½¿ç”¨ manual æ¨¡å¼ï¼Œè¿™æ ·è„šæœ¬åªç®¡ç”Ÿæˆ PDFï¼Œä¸ä¼šæŠ¥é”™ä¹Ÿä¸ä¼šé‡å¤å‘æ¶ˆæ¯
        python github_stock_bot.py --mode manual --stocks "$STOCKS"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰PDFæ–‡ä»¶ç”Ÿæˆï¼ˆç›´æŽ¥ç»Ÿè®¡PDFæ–‡ä»¶ï¼‰
        PDF_COUNT=$(python3 -c "
        import os
        import glob
        run_start = int(os.environ.get('RUN_START_TIME', 0))
        # æŸ¥æ‰¾æœ€æ–°æŠ¥å‘Šæ–‡ä»¶å¤¹
        report_dirs = glob.glob('reports/reports_*')
        if not report_dirs:
            print(0)
            exit()
        latest_dir = max(report_dirs, key=os.path.getmtime)
        # åªç»Ÿè®¡åœ¨è¿è¡Œå¼€å§‹åŽåˆ›å»ºçš„PDFæ–‡ä»¶ï¼ˆå…è®¸60ç§’è¯¯å·®ï¼‰
        pdf_paths = glob.glob(os.path.join(latest_dir, '*.pdf'))
        pdf_paths = [p for p in pdf_paths if os.path.isfile(p) and os.path.getmtime(p) >= run_start - 60]
        print(len(pdf_paths))
        ")
        echo "æœ¬æ¬¡è¿è¡Œç”Ÿæˆçš„PDFæ•°é‡: $PDF_COUNT"
        echo "PDF_COUNT=$PDF_COUNT" >> $GITHUB_OUTPUT
        
        # ä¿å­˜æŠ¥å‘Šç›®å½•è·¯å¾„ä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
        REPORT_DIR=$(python3 -c "
        import os
        import glob
        run_start = int(os.environ.get('RUN_START_TIME', 0))
        report_dirs = glob.glob('reports/reports_*')
        if report_dirs:
            latest_dir = max(report_dirs, key=os.path.getmtime)
            print(os.path.abspath(latest_dir))
        ")
        echo "REPORT_DIR=$REPORT_DIR" >> $GITHUB_ENV
        echo "æŠ¥å‘Šç›®å½•: $REPORT_DIR"
    
    - name: å‘é€æŠ¥å‘Šåˆ° Telegramï¼ˆå¤šæ–‡ä»¶æŽ¨é€ï¼‰ðŸš€
      if: steps.run_analysis.outcome == 'success' && steps.run_analysis.outputs.PDF_COUNT > 0
      run: |
        REPORT_DIR="${{ env.REPORT_DIR }}"
        if [ -z "$REPORT_DIR" ] || [ ! -d "$REPORT_DIR" ]; then
          echo "âŒ æŠ¥å‘Šç›®å½•ä¸å­˜åœ¨: $REPORT_DIR"
          exit 1
        fi
        
        TELEGRAM_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
        TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
        
        if [ -z "$TELEGRAM_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
          echo "âŒ Telegramé…ç½®ç¼ºå¤±ï¼Œè¯·æ£€æŸ¥secrets: TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID"
          exit 1
        fi
        
        # ç»Ÿè®¡PDFæ–‡ä»¶æ•°é‡
        PDF_FILES=("$REPORT_DIR"/*.pdf)
        PDF_COUNT=${#PDF_FILES[@]}
        
        if [ $PDF_COUNT -eq 0 ]; then
          echo "âš ï¸ æœªæ‰¾åˆ°PDFæ–‡ä»¶"
          exit 1
        fi
        
        echo "ðŸ“¤ å¼€å§‹å‘é€ $PDF_COUNT ä¸ªPDFæ–‡ä»¶åˆ°Telegram..."
        
        SUCCESS_COUNT=0
        FAIL_COUNT=0
        
        # å¾ªçŽ¯å‘é€æ¯ä¸ªPDFæ–‡ä»¶
        for pdf_file in "$REPORT_DIR"/*.pdf; do
          if [ ! -f "$pdf_file" ]; then
            continue
          fi
          
          FILENAME=$(basename "$pdf_file")
          FILE_SIZE=$(stat -f%z "$pdf_file" 2>/dev/null || stat -c%s "$pdf_file" 2>/dev/null || echo "0")
          FILE_SIZE_MB=$((FILE_SIZE / 1024 / 1024))
          
          # Telegram Bot API æ–‡ä»¶å¤§å°é™åˆ¶ä¸º 50MB
          if [ $FILE_SIZE_MB -gt 50 ]; then
            echo "âš ï¸ è·³è¿‡æ–‡ä»¶ $FILENAME (å¤§å°: ${FILE_SIZE_MB}MBï¼Œè¶…è¿‡50MBé™åˆ¶)"
            FAIL_COUNT=$((FAIL_COUNT + 1))
            continue
          fi
          
          echo "ðŸ“„ æ­£åœ¨å‘é€: $FILENAME (${FILE_SIZE_MB}MB)..."
          
          # å‘é€æ–‡ä»¶åˆ°Telegram
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -F "chat_id=$TELEGRAM_CHAT_ID" \
            -F "document=@$pdf_file" \
            "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendDocument" 2>&1)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… æˆåŠŸå‘é€: $FILENAME"
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          else
            echo "âŒ å‘é€å¤±è´¥: $FILENAME (HTTP $HTTP_CODE)"
            echo "å“åº”: $BODY"
            FAIL_COUNT=$((FAIL_COUNT + 1))
          fi
          
          # é¿å…è¯·æ±‚è¿‡å¿«ï¼Œæ·»åŠ çŸ­æš‚å»¶è¿Ÿ
          sleep 1
        done
        
        echo ""
        echo "ðŸ“Š å‘é€å®Œæˆç»Ÿè®¡:"
        echo "  âœ… æˆåŠŸ: $SUCCESS_COUNT"
        echo "  âŒ å¤±è´¥: $FAIL_COUNT"
        echo "  ðŸ“„ æ€»è®¡: $PDF_COUNT"
        
        # å‘é€å®Œæˆé€šçŸ¥
        if [ $SUCCESS_COUNT -gt 0 ]; then
          curl -s -X POST \
            -F "chat_id=$TELEGRAM_CHAT_ID" \
            -F "text=âœ… Felixï¼Œæœºå™¨äººå·²å®Œæˆè‚¡ç¥¨åˆ†æžæŠ¥å‘ŠæŽ¨é€ï¼ˆæˆåŠŸ: $SUCCESS_COUNT/$PDF_COUNTï¼‰" \
            "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" > /dev/null
        fi
        
        # å¦‚æžœæœ‰å¤±è´¥çš„æ–‡ä»¶ï¼Œé€€å‡ºç ä¸º1
        if [ $FAIL_COUNT -gt 0 ]; then
          exit 1
        fi

    - name: ä¸Šä¼ æŠ¥å‘Šåˆ° Google Drive ðŸ“
      if: steps.run_analysis.outcome == 'success' && steps.run_analysis.outputs.PDF_COUNT > 0
      uses: adityak74/google-drive-upload-git-action@main
      with:
        filename: ${{ env.REPORT_DIR }}/*.pdf
        credentials: ${{ secrets.GDRIVE_CREDENTIALS }}
        folderId: ${{ secrets.GDRIVE_FOLDER_ID }}
