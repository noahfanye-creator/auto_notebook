name: è‚¡ç¥¨åˆ†ææœºå™¨äºº ğŸ¤–

on:
  schedule:
    # 1. æ¯å¤©æ—©ç›˜ (åŒ—äº¬æ—¶é—´ 09:15) -> UTC 01:15
    - cron: '15 1 * * 1-5'
    # 2. æ¯å¤©åˆç›˜ (åŒ—äº¬æ—¶é—´ 12:00) -> UTC 04:00
    - cron: '0 4 * * 1-5'
    # 3. æ¯å¤©ä¸‹åˆ (åŒ—äº¬æ—¶é—´ 15:00) -> UTC 07:00
    - cron: '0 7 * * 1-5'
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘é…ç½®
    inputs:
      stocks:
        description: 'è¾“å…¥è‚¡ç¥¨ä»£ç ï¼ˆé€—å·åˆ†éš”ï¼‰'
        required: false
        default: '600460,300474,300623,300019'

jobs:
  analyze-stocks:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas numpy reportlab akshare matplotlib pytz
        sudo apt-get update
        sudo apt-get install -y fonts-wqy-zenhei
    
    - name: è¿è¡Œè‚¡ç¥¨åˆ†æå¹¶å‘é€ Telegram
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        export TZ='Asia/Shanghai'
        # ä½¿ç”¨ç¯å¢ƒå˜é‡å¤„ç†ï¼šä¼˜å…ˆä½¿ç”¨æ‰‹åŠ¨è¾“å…¥çš„ stocksï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤çš„ 4 æ”¯è‚¡ç¥¨
        STOCKS="${{ github.event.inputs.stocks }}"
        if [ -z "$STOCKS" ]; then
          STOCKS="600460,300474,300623,300019"
        fi
        
        # è¿è¡Œè„šæœ¬ã€‚æ³¨æ„ï¼šè„šæœ¬å†…éƒ¨å·²åŒ…å«å‘é€é€»è¾‘ï¼Œæ— éœ€é¢å¤–æ’ä»¶
        python github_stock_bot.py --mode telegram --stocks "$STOCKS"
    
    - name: ä¸Šä¼ æŠ¥å‘Šåˆ° GitHub (ä½œä¸ºå¤‡ä»½å­˜æ¡£)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: stock-reports-${{ github.run_id }}
        path: |
          reports/**/*.pdf
          reports/**/*.zip
