name: è‚¡ç¥¨åˆ†ææœºå™¨äºº ğŸ¤–

# ============================================================================
# GitHub Repository Secrets é…ç½®è¯´æ˜
# ============================================================================
# è¯·åœ¨ GitHub Repository Settings > Secrets and variables > Actions ä¸­é…ç½®ä»¥ä¸‹å˜é‡ï¼š
#
# 1. TELEGRAM_BOT_TOKEN
#    è¯´æ˜: Telegram Bot Token
#    è·å–æ–¹å¼: é€šè¿‡ @BotFather åˆ›å»ºæœºå™¨äººåè·å–
#    ç¤ºä¾‹: 123456789:ABCdefGHIjklMNOpqrsTUVwxyz
#
# 2. TELEGRAM_CHAT_ID
#    è¯´æ˜: Telegram Chat IDï¼ˆæ¥æ”¶æ¶ˆæ¯çš„èŠå¤©IDï¼‰
#    è·å–æ–¹å¼: é€šè¿‡ @userinfobot æˆ– @getidsbot è·å–
#    ç¤ºä¾‹: 123456789
#
# 3. GDRIVE_CLIENT_ID, GDRIVE_CLIENT_SECRET, GDRIVE_REFRESH_TOKEN (å¯é€‰)
#    è¯´æ˜: Google Drive OAuth å‡­è¯ï¼ˆç”¨äºä¸ªäººè´¦å·æˆæƒä¸Šä¼ ï¼Œé¿å¼€æœåŠ¡è´¦å·é…é¢é™åˆ¶ï¼‰
#    è·å–æ–¹å¼:
#       a) åœ¨ Google Cloud Console åˆ›å»º OAuth 2.0 å®¢æˆ·ç«¯ IDï¼ˆåº”ç”¨ç±»å‹é€‰ "æ¡Œé¢åº”ç”¨"ï¼‰
#       b) è·å– Client ID å’Œ Client Secret
#       c) ä½¿ç”¨æˆæƒå·¥å…·è·å– Refresh Token
#    ç¤ºä¾‹: 
#       GDRIVE_CLIENT_ID: 123456789-abc.apps.googleusercontent.com
#       GDRIVE_CLIENT_SECRET: GOCSPX-abc...
#       GDRIVE_REFRESH_TOKEN: 1//0abc...
#    æ³¨æ„: å¦‚æœä¸é…ç½®è¿™äº› secretsï¼Œå°†è·³è¿‡ Google Drive ä¸Šä¼ æ­¥éª¤
#
# 4. GDRIVE_FOLDER_ID (å¯é€‰)
#    è¯´æ˜: Google Drive ç›®æ ‡æ–‡ä»¶å¤¹ IDï¼ˆæ”¯æŒåä½œäº‘ç«¯ç¡¬ç›˜æˆ–ä¸ªäººæ–‡ä»¶å¤¹ï¼‰
#    è·å–æ–¹å¼: åœ¨ Drive ä¸­æ‰“å¼€è¯¥æ–‡ä»¶å¤¹ï¼Œä» URL çš„ folders/xxx æå– ID
#    ç¤ºä¾‹: 1a2b3c4d5e6f7g8h9i0j
#    æ³¨æ„: å¦‚æœä¸é…ç½®æ­¤ secretï¼Œå°†è·³è¿‡ Google Drive ä¸Šä¼ æ­¥éª¤
#
# Google Drive ä¸Šä¼ æ³¨æ„äº‹é¡¹:
# - å·²åˆ‡æ¢åˆ° OAuth æ–¹æ¡ˆï¼Œä¸å†éœ€è¦ GDRIVE_CREDENTIALS å’Œ GDRIVE_OWNER_EMAIL
# - æ–‡ä»¶å¤¹é…ç½®ï¼š
#     åœ¨ã€Œæˆ‘çš„äº‘ç«¯ç¡¬ç›˜ã€åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œç¡®ä¿æˆæƒè´¦å·æœ‰æƒè®¿é—®è¯¥æ–‡ä»¶å¤¹
#   â†’ ç”¨è¯¥æ–‡ä»¶å¤¹ ID ä½œä¸º GDRIVE_FOLDER_ID
# - ç¡®ä¿å·²å¯ç”¨ Google Drive API
# - å¦‚æœæš‚æ—¶ä¸éœ€è¦ä¸Šä¼ åˆ° Google Driveï¼Œå¯ä»¥ä¸é…ç½®è¿™äº› secretsï¼Œworkflow ä¼šè·³è¿‡ä¸Šä¼ æ­¥éª¤
#
# 5. NLM_CONFIG
#    è¯´æ˜: nlm CLI çš„ Google æˆæƒå‡­è¯ï¼ˆç¯å¢ƒå˜é‡æ ¼å¼ï¼‰
#    è·å–æ–¹å¼: æœ¬åœ°æ‰§è¡Œ `cat ~/.nlm/env` è·å–å®Œæ•´å†…å®¹
#    ç¤ºä¾‹: 
#     NLM_COOKIES="__Secure-3PSIDCC=..."
#     NLM_AUTH_TOKEN="AE_..."
#     NLM_BROWSER_PROFILE="Profile 3"
#
# 6. NOTEBOOKLM_ID
#    è¯´æ˜: NotebookLM ç›®æ ‡ç¬”è®°æœ¬ ID
#    è·å–æ–¹å¼: 
#       a) ä»ç½‘é¡µ URL è·å–ï¼šæ‰“å¼€ NotebookLM ç¬”è®°æœ¬ï¼ŒURL æ ¼å¼ä¸º
#          https://notebooklm.google.com/notebook/437c839c-5a24-455b-b8da-d35ba8931811
#          ID å°±æ˜¯ /notebook/ åé¢çš„éƒ¨åˆ†
#       b) æœ¬åœ°æ‰§è¡Œ `source ~/.nlm/env && nlm list` è·å–
#    ç¤ºä¾‹: 437c839c-5a24-455b-b8da-d35ba8931811
#
# 7. CUSTOM_QUESTION
#    è¯´æ˜: å®šåˆ¶é—®ç­”å†…å®¹
#    è·å–æ–¹å¼: è‡ªå®šä¹‰é—®é¢˜ï¼Œå¦‚ã€Œåˆ†ææœ¬æ¬¡ä¸Šä¼ çš„æ‰€æœ‰PDFæŠ¥å‘Šï¼Œæ±‡æ€»æ ¸å¿ƒç»“è®ºå’Œå…³é”®æ•°æ®ã€
#    ç¤ºä¾‹: åˆ†ææœ¬æ¬¡ä¸Šä¼ çš„æ‰€æœ‰PDFæŠ¥å‘Šï¼Œæ±‡æ€»æ ¸å¿ƒç»“è®ºå’Œå…³é”®æ•°æ®
#
# æ³¨æ„: NotebookLM æµç¨‹æ¨é€ä½¿ç”¨ä¸è‚¡ç¥¨åˆ†ææŠ¥å‘Šç›¸åŒçš„ Telegram é…ç½®
#       å³ä½¿ç”¨ TELEGRAM_BOT_TOKEN å’Œ TELEGRAM_CHAT_IDï¼ˆæ— éœ€é¢å¤–é…ç½®ï¼‰
# ============================================================================

on:
  schedule:
    # äº¤æ˜“æ—¥åˆç›˜ä¸æ”¶ç›˜ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
    # Aè‚¡ï¼š11:30 / 15:00ï¼›æ¸¯è‚¡ï¼š12:00 / 16:00
    # è§¦å‘æ—¶é—´åŠ  5 åˆ†é’Ÿç¼“å†²
    - cron: '35 3 * * 1-5'  # 11:35
    - cron: '5 4 * * 1-5'   # 12:05
    - cron: '5 7 * * 1-5'   # 15:05
    - cron: '10 8 * * 1-5'  # 16:10
  workflow_dispatch:
    inputs:
      stocks:
        description: 'è¾“å…¥è‚¡ç¥¨ä»£ç ï¼ˆæ”¯æŒAè‚¡å’Œæ¸¯è‚¡ï¼Œå¦‚ï¼š600460,00700ï¼‰'
        required: false
        default: '688630,600460,300474,300623,300019'

jobs:
  analyze-stocks:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    outputs:
      PDF_COUNT: ${{ steps.run_analysis.outputs.PDF_COUNT }}
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-core.txt -r requirements-optional.txt
        pip install pytz
        sudo apt-get update
        sudo apt-get install -y fonts-wqy-zenhei

    - name: è¿è¡Œè‚¡ç¥¨åˆ†æ
      id: run_analysis
      timeout-minutes: 25
      continue-on-error: true
      env:
        DATABASE_ENABLED: "false"
      run: |
        # ä¸´æ—¶ç¦ç”¨æ•°æ®åº“ï¼šæŠ¥å‘Šåªç”¨æ¥å£å®æ—¶æ•°æ®ï¼Œä¸è¯»ä¸å†™æœ¬åœ° DB
        export TZ='Asia/Shanghai'
        # è®°å½•è¿è¡Œå¼€å§‹æ—¶é—´
        export RUN_START_TIME=$(date +%s)
        echo "RUN_START_TIME=$RUN_START_TIME" >> $GITHUB_ENV
        echo "è¿è¡Œå¼€å§‹æ—¶é—´: $(date) (Timestamp: $RUN_START_TIME)"
        
        STOCKS="${{ github.event.inputs.stocks }}"
        if [ -z "$STOCKS" ]; then
          STOCKS="688630,600460,300474,300623,300019"
        fi
        STOCKS="${STOCKS//,/ }"
        STOCKS="${STOCKS//ï¼Œ/ }"
        STOCKS="$(echo "$STOCKS" | xargs)"
        # ä½¿ç”¨ manual æ¨¡å¼ï¼Œè¿™æ ·è„šæœ¬åªç®¡ç”Ÿæˆ PDFï¼Œä¸ä¼šæŠ¥é”™ä¹Ÿä¸ä¼šé‡å¤å‘æ¶ˆæ¯
        python github_stock_bot.py --mode manual --stocks "$STOCKS"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰PDFæ–‡ä»¶ç”Ÿæˆï¼ˆç›´æ¥ç»Ÿè®¡PDFæ–‡ä»¶ï¼‰
        PDF_COUNT=$(python3 -c "
        import os
        import glob
        run_start = int(os.environ.get('RUN_START_TIME', 0))
        # æŸ¥æ‰¾æœ€æ–°æŠ¥å‘Šæ–‡ä»¶å¤¹
        report_dirs = glob.glob('reports/reports_*')
        if not report_dirs:
            print(0)
            exit()
        latest_dir = max(report_dirs, key=os.path.getmtime)
        # åªç»Ÿè®¡åœ¨è¿è¡Œå¼€å§‹ååˆ›å»ºçš„PDFæ–‡ä»¶ï¼ˆå…è®¸60ç§’è¯¯å·®ï¼‰
        pdf_paths = glob.glob(os.path.join(latest_dir, '*.pdf'))
        pdf_paths = [p for p in pdf_paths if os.path.isfile(p) and os.path.getmtime(p) >= run_start - 60]
        print(len(pdf_paths))
        ")
        echo "æœ¬æ¬¡è¿è¡Œç”Ÿæˆçš„PDFæ•°é‡: $PDF_COUNT"
        echo "PDF_COUNT=$PDF_COUNT" >> $GITHUB_OUTPUT
        
        # ä¿å­˜æŠ¥å‘Šç›®å½•è·¯å¾„ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        REPORT_DIR=$(python3 -c "
        import os
        import glob
        run_start = int(os.environ.get('RUN_START_TIME', 0))
        report_dirs = glob.glob('reports/reports_*')
        if report_dirs:
            latest_dir = max(report_dirs, key=os.path.getmtime)
            print(os.path.abspath(latest_dir))
        ")
        echo "REPORT_DIR=$REPORT_DIR" >> $GITHUB_ENV
        echo "æŠ¥å‘Šç›®å½•: $REPORT_DIR"
    
    - name: å‘é€æŠ¥å‘Šåˆ° Telegramï¼ˆå¤šæ–‡ä»¶æ¨é€ï¼‰ğŸš€
      if: steps.run_analysis.outcome == 'success' && steps.run_analysis.outputs.PDF_COUNT > 0
      run: |
        REPORT_DIR="${{ env.REPORT_DIR }}"
        if [ -z "$REPORT_DIR" ] || [ ! -d "$REPORT_DIR" ]; then
          echo "âŒ æŠ¥å‘Šç›®å½•ä¸å­˜åœ¨: $REPORT_DIR"
          exit 1
        fi
        
        TELEGRAM_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
        TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
        
        if [ -z "$TELEGRAM_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
          echo "âŒ Telegramé…ç½®ç¼ºå¤±ï¼Œè¯·æ£€æŸ¥secrets: TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID"
          exit 1
        fi
        
        # ç»Ÿè®¡PDFæ–‡ä»¶æ•°é‡
        PDF_FILES=("$REPORT_DIR"/*.pdf)
        PDF_COUNT=${#PDF_FILES[@]}
        
        if [ $PDF_COUNT -eq 0 ]; then
          echo "âš ï¸ æœªæ‰¾åˆ°PDFæ–‡ä»¶"
          exit 1
        fi
        
        echo "ğŸ“¤ å¼€å§‹å‘é€ $PDF_COUNT ä¸ªPDFæ–‡ä»¶åˆ°Telegram..."
        
        SUCCESS_COUNT=0
        FAIL_COUNT=0
        
        # å¾ªç¯å‘é€æ¯ä¸ªPDFæ–‡ä»¶
        for pdf_file in "$REPORT_DIR"/*.pdf; do
          if [ ! -f "$pdf_file" ]; then
            continue
          fi
          
          FILENAME=$(basename "$pdf_file")
          FILE_SIZE=$(stat -f%z "$pdf_file" 2>/dev/null || stat -c%s "$pdf_file" 2>/dev/null || echo "0")
          FILE_SIZE_MB=$((FILE_SIZE / 1024 / 1024))
          
          # Telegram Bot API æ–‡ä»¶å¤§å°é™åˆ¶ä¸º 50MB
          if [ $FILE_SIZE_MB -gt 50 ]; then
            echo "âš ï¸ è·³è¿‡æ–‡ä»¶ $FILENAME (å¤§å°: ${FILE_SIZE_MB}MBï¼Œè¶…è¿‡50MBé™åˆ¶)"
            FAIL_COUNT=$((FAIL_COUNT + 1))
            continue
          fi
          
          echo "ğŸ“„ æ­£åœ¨å‘é€: $FILENAME (${FILE_SIZE_MB}MB)..."
          
          # å‘é€æ–‡ä»¶åˆ°Telegram
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -F "chat_id=$TELEGRAM_CHAT_ID" \
            -F "document=@$pdf_file" \
            "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendDocument" 2>&1)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… æˆåŠŸå‘é€: $FILENAME"
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          else
            echo "âŒ å‘é€å¤±è´¥: $FILENAME (HTTP $HTTP_CODE)"
            echo "å“åº”: $BODY"
            FAIL_COUNT=$((FAIL_COUNT + 1))
          fi
          
          # é¿å…è¯·æ±‚è¿‡å¿«ï¼Œæ·»åŠ çŸ­æš‚å»¶è¿Ÿ
          sleep 1
        done
        
        echo ""
        echo "ğŸ“Š å‘é€å®Œæˆç»Ÿè®¡:"
        echo "  âœ… æˆåŠŸ: $SUCCESS_COUNT"
        echo "  âŒ å¤±è´¥: $FAIL_COUNT"
        echo "  ğŸ“„ æ€»è®¡: $PDF_COUNT"
        
        # å‘é€å®Œæˆé€šçŸ¥
        if [ $SUCCESS_COUNT -gt 0 ]; then
          curl -s -X POST \
            -F "chat_id=$TELEGRAM_CHAT_ID" \
            -F "text=âœ… Felixï¼Œæœºå™¨äººå·²å®Œæˆè‚¡ç¥¨åˆ†ææŠ¥å‘Šæ¨é€ï¼ˆæˆåŠŸ: $SUCCESS_COUNT/$PDF_COUNTï¼‰" \
            "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" > /dev/null
        fi
        
        # å¦‚æœæœ‰å¤±è´¥çš„æ–‡ä»¶ï¼Œé€€å‡ºç ä¸º1
        if [ $FAIL_COUNT -gt 0 ]; then
          exit 1
        fi

    - name: ä¸Šä¼ æŠ¥å‘Šåˆ° Google Drive ğŸ“
      if: steps.run_analysis.outcome == 'success' && steps.run_analysis.outputs.PDF_COUNT > 0
      env:
        GDRIVE_CLIENT_ID: ${{ secrets.GDRIVE_CLIENT_ID }}
        GDRIVE_CLIENT_SECRET: ${{ secrets.GDRIVE_CLIENT_SECRET }}
        GDRIVE_REFRESH_TOKEN: ${{ secrets.GDRIVE_REFRESH_TOKEN }}
        GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        REPORT_DIR: ${{ env.REPORT_DIR }}
      run: |
        pip install -q google-auth google-api-python-client
        python - << 'PY'
        import os
        import json
        import glob
        from google.oauth2.credentials import Credentials
        from googleapiclient.discovery import build
        from googleapiclient.http import MediaFileUpload
        from googleapiclient.errors import HttpError

        report_dir = os.environ["REPORT_DIR"]
        client_id = os.environ.get("GDRIVE_CLIENT_ID", "").strip()
        client_secret = os.environ.get("GDRIVE_CLIENT_SECRET", "").strip()
        refresh_token = os.environ.get("GDRIVE_REFRESH_TOKEN", "").strip()
        folder_id = os.environ.get("GDRIVE_FOLDER_ID", "").strip()

        if not all([client_id, client_secret, refresh_token, folder_id]):
            print("âš ï¸  Google Drive é…ç½®æœªè®¾ç½®ï¼Œè·³è¿‡ä¸Šä¼ æ­¥éª¤")
            exit(0)

        # ä½¿ç”¨ Refresh Token æ„å»ºå‡­è¯
        creds = Credentials(
            None,
            refresh_token=refresh_token,
            token_uri="https://oauth2.googleapis.com/token",
            client_id=client_id,
            client_secret=client_secret,
            scopes=["https://www.googleapis.com/auth/drive"]
        )
        
        drive = build("drive", "v3", credentials=creds)

        # æ ¡éªŒæ–‡ä»¶å¤¹
        try:
            folder_info = drive.files().get(fileId=folder_id, fields="id,name", supportsAllDrives=True).execute()
            print(f"ğŸ“ ç›®æ ‡æ–‡ä»¶å¤¹: {folder_info.get('name', folder_id)}")
        except Exception as e:
            raise SystemExit(f"æ— æ³•è®¿é—® Google Drive æ–‡ä»¶å¤¹: {e}\nè¯·æ£€æŸ¥ GDRIVE_FOLDER_ID æ˜¯å¦æ­£ç¡®ï¼Œä¸”æˆæƒè´¦å·æœ‰æƒè®¿é—®ã€‚")

        pdfs = sorted(glob.glob(os.path.join(report_dir, "*.pdf")))
        if not pdfs:
            raise SystemExit("æœªæ‰¾åˆ° PDF æ–‡ä»¶")

        for path in pdfs:
            name = os.path.basename(path)
            meta = {"name": name, "parents": [folder_id]}
            media = MediaFileUpload(path, mimetype="application/pdf", resumable=True)
            try:
                f = drive.files().create(
                    body=meta,
                    media_body=media,
                    fields="id,name",
                    supportsAllDrives=True,
                ).execute()
                print(f"  âœ… ä¸Šä¼ æˆåŠŸ: {name} -> {f.get('id')}")
            except HttpError as e:
                print(f"  âŒ ä¸Šä¼ å¤±è´¥: {name} (HTTP {e.resp.status})")
                print(f"  é”™è¯¯è¯¦æƒ…: {e}")
                
        print(f"\nğŸ“Š å…±ä¸Šä¼  {len(pdfs)} ä¸ªæ–‡ä»¶")
        PY

  nlm-simple-auto:
    needs: [analyze-stocks]
    runs-on: ubuntu-latest
    if: success() && needs.analyze-stocks.outputs.PDF_COUNT > 0
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… nlm CLI å·¥å…·
        run: |
          sudo apt update && sudo apt install -y golang
          go install github.com/tmc/nlm/cmd/nlm@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: é…ç½® NotebookLM æˆæƒå‡­è¯
        run: |
          mkdir -p $HOME/.nlm
          cat > $HOME/.nlm/env << 'EOF'
          ${{ secrets.NLM_CONFIG }}
          EOF
          source $HOME/.nlm/env

      - name: æ‰§è¡Œã€Œä¸Šä¼ +é—®ç­”+åˆ æºã€æ ¸å¿ƒè„šæœ¬
        id: nlm-run
        run: |
          source $HOME/.nlm/env
          cat > ./nlm_simple.sh << 'EOF'
          #!/bin/bash
          source $HOME/.nlm/env
          NOTEBOOK_ID="${{ secrets.NOTEBOOKLM_ID }}"
          CUSTOM_QUESTION="${{ secrets.CUSTOM_QUESTION }}"
          PDF_DIR=$(python3 -c "
          import os
          import glob
          report_dirs = glob.glob('reports/reports_*')
          if report_dirs:
              latest_dir = max(report_dirs, key=os.path.getmtime)
              print(os.path.abspath(latest_dir))
          else:
              print('')
          ")
          ANSWER_FILE="./nlm_answer.txt"
          SOURCE_IDS_FILE="./source_ids.txt"
          LOG_FILE="./nlm_log.txt"

          > $ANSWER_FILE && > $SOURCE_IDS_FILE && > $LOG_FILE
          echo "ğŸ“… æ‰§è¡Œæ—¶é—´ï¼š$(date +'%Y-%m-%d %H:%M:%S')" >> $LOG_FILE
          echo "ğŸ“ PDFç›®å½•ï¼š$PDF_DIR" >> $LOG_FILE
          echo "----------------------------------------" >> $LOG_FILE

          if [ -z "$PDF_DIR" ] || [ ! -d "$PDF_DIR" ]; then
            echo "âŒ é”™è¯¯ï¼šPDFç›®å½•$PDF_DIRä¸å­˜åœ¨" >> $LOG_FILE
            echo "pdf_count=0" >> $GITHUB_OUTPUT
            exit 1
          fi
          PDF_FILES=($PDF_DIR/*.pdf)
          PDF_COUNT=${#PDF_FILES[@]}
          if [ $PDF_COUNT -eq 0 ]; then
            echo "âŒ é”™è¯¯ï¼šPDFç›®å½•ä¸‹æ— ä»»ä½•PDFæ–‡ä»¶" >> $LOG_FILE
            echo "pdf_count=0" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "ğŸ” æ‰¾åˆ°å¯ä¸Šä¼ PDFæ•°é‡ï¼š$PDF_COUNTä¸ª" >> $LOG_FILE
          echo "pdf_count=$PDF_COUNT" >> $GITHUB_OUTPUT

          echo "ğŸš€ å¼€å§‹æ‰¹é‡ä¸Šä¼ PDFï¼ˆ1ç§’/ä¸ªï¼‰..." >> $LOG_FILE
          SUCCESS_UPLOAD=0
          for pdf in "${PDF_FILES[@]}"; do
            if [ -f "$pdf" ]; then
              FILE_NAME=$(basename "$pdf")
              UPLOAD_RESULT=$(nlm sources add --notebook $NOTEBOOK_ID --file "$pdf" 2>&1)
              if [[ $UPLOAD_RESULT =~ "added source ([a-zA-Z0-9-]+)" ]]; then
                SOURCE_ID=${BASH_REMATCH[1]}
                echo $SOURCE_ID >> $SOURCE_IDS_FILE
                echo "âœ… ä¸Šä¼ æˆåŠŸï¼š$FILE_NAME | æ¥æºIDï¼š$SOURCE_ID" >> $LOG_FILE
                SUCCESS_UPLOAD=$((SUCCESS_UPLOAD+1))
              else
                echo "âš ï¸  ä¸Šä¼ å¤±è´¥ï¼š$FILE_NAMEï¼ˆè·³è¿‡ï¼‰" >> $LOG_FILE
              fi
              sleep 1
            fi
          done
          echo "ğŸ“Š ä¸Šä¼ ç»“æœï¼šæˆåŠŸ$SUCCESS_UPLOADä¸ª | æ€»æ•°é‡$PDF_COUNTä¸ª" >> $LOG_FILE
          echo "----------------------------------------" >> $LOG_FILE

          echo "ğŸ¤– å¼€å§‹æ‰§è¡Œå®šåˆ¶é—®ç­”..." >> $LOG_FILE
          if nlm ask --notebook $NOTEBOOK_ID --raw "$CUSTOM_QUESTION" > $ANSWER_FILE 2>&1; then
            echo "âœ… é—®ç­”æˆåŠŸï¼Œç»“æœå·²ä¿å­˜" >> $LOG_FILE
          else
            echo "âŒ é—®ç­”å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—æ’æŸ¥" >> $LOG_FILE
            echo "NotebookLMé—®ç­”æ‰§è¡Œå¤±è´¥ï¼Œè¯·æŸ¥çœ‹GitHub Actionè¿è¡Œæ—¥å¿—" > $ANSWER_FILE
          fi
          echo "----------------------------------------" >> $LOG_FILE

          echo "ğŸ—‘ï¸  å¼€å§‹æ‰¹é‡åˆ é™¤æœ¬æ¬¡ä¸Šä¼ æ¥æº..." >> $LOG_FILE
          if [ -s $SOURCE_IDS_FILE ] && [ $SUCCESS_UPLOAD -gt 0 ]; then
            SOURCE_IDS=$(cat $SOURCE_IDS_FILE | tr '\n' ' ')
            nlm sources delete --notebook $NOTEBOOK_ID $SOURCE_IDS >/dev/null 2>&1
            echo "âœ… æ‰¹é‡åˆ é™¤å®Œæˆï¼šå…±åˆ é™¤$SUCCESS_UPLOADä¸ªæœ¬æ¬¡ä¸Šä¼ æ¥æº" >> $LOG_FILE
          else
            echo "âš ï¸  æ— æœ‰æ•ˆæ¥æºIDï¼Œè·³è¿‡åˆ é™¤" >> $LOG_FILE
          fi

          cat $LOG_FILE
          EOF
          chmod +x ./nlm_simple.sh && ./nlm_simple.sh

      - name: Telegram Bot æ¨é€æœ€ç»ˆç»“æœ
        run: |
          PDF_COUNT=${{ steps.nlm-run.outputs.pdf_count }}
          RUN_TIME=$(date +'%Y-%m-%d %H:%M:%S')
          ANSWER=$(cat ./nlm_answer.txt | sed 's/"/\\"/g' | tr '\n' '\\n')
          MESSAGE="ğŸ“Šã€NotebookLMè‡ªåŠ¨åŒ–æ‰§è¡Œç»“æœã€‘\nâ° æ‰§è¡Œæ—¶é—´ï¼š$RUN_TIME\nğŸ”¢ æœ¬æ¬¡ä¸Šä¼ PDFï¼š$PDF_COUNTä¸ª\nğŸ—‘ï¸  å·²è‡ªåŠ¨åˆ é™¤æœ¬æ¬¡ä¸Šä¼ æ‰€æœ‰æ¥æº\nğŸ’¡ æ ¸å¿ƒå›ç­”ï¼š\n$ANSWER"
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d '{
              "chat_id": "${{ secrets.TELEGRAM_CHAT_ID }}",
              "text": "'"$MESSAGE"'",
              "parse_mode": "markdown",
              "disable_web_page_preview": true
            }'
