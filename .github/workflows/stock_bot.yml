name: è‚¡ç¥¨åˆ†ææœºå™¨äºº ğŸ¤–

on:
  schedule:
    - cron: '15 1 * * 1-5'
    - cron: '0 4 * * 1-5'
    - cron: '0 7 * * 1-5'
  workflow_dispatch:
    inputs:
      stocks:
        description: 'è¾“å…¥è‚¡ç¥¨ä»£ç '
        required: false
        default: '688630,600460,300474,300623,300019'

jobs:
  analyze-stocks:
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas numpy reportlab akshare matplotlib pytz
        sudo apt-get update
        sudo apt-get install -y fonts-wqy-zenhei
    
    - name: è¿è¡Œè‚¡ç¥¨åˆ†æ
      # è¿™é‡Œæ³¨æ„ï¼šæˆ‘æŠŠ mode æ”¹å›äº† manualï¼Œè¿™æ˜¯ä½ è„šæœ¬æ”¯æŒçš„
      run: |
        export TZ='Asia/Shanghai'
        STOCKS="${{ github.event.inputs.stocks }}"
        if [ -z "$STOCKS" ]; then
          STOCKS="688630,600460,300474,300623,300019"
        fi
        # ä½¿ç”¨ manual æ¨¡å¼ï¼Œè¿™æ ·è„šæœ¬åªç®¡ç”Ÿæˆ PDFï¼Œä¸ä¼šæŠ¥é”™ä¹Ÿä¸ä¼šé‡å¤å‘æ¶ˆæ¯
        python github_stock_bot.py --mode manual --stocks "$STOCKS"
    
    - name: æ•´ç†æŠ¥å‘Šæ–‡ä»¶
      run: |
        mkdir -p final_delivery
        # ä½ çš„è„šæœ¬ä¼šç”Ÿæˆ reports/ æ–‡ä»¶å¤¹ï¼Œæˆ‘ä»¬æŠŠé‡Œé¢çš„ zip æ‰¾å‡ºæ¥
        find reports -name "*.zip" -exec cp {} final_delivery/stock_report.zip \;

    - name: ä¸Šä¼ æŠ¥å‘Šåˆ° Google Drive
      if: success()
      env:
        GDRIVE_SERVICE_ACCOUNT_JSON: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}
        GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
      run: |
        if [ -z "$GDRIVE_SERVICE_ACCOUNT_JSON" ] || [ -z "$GDRIVE_FOLDER_ID" ]; then
          echo "âŒ ç¼ºå°‘ Google Drive é…ç½®ï¼ˆGDRIVE_SERVICE_ACCOUNT_JSON / GDRIVE_FOLDER_IDï¼‰"
          exit 1
        fi
        echo "$GDRIVE_SERVICE_ACCOUNT_JSON" > /tmp/gdrive.json
        curl -fsSL https://rclone.org/install.sh | sudo bash
        mkdir -p ~/.config/rclone
        cat > ~/.config/rclone/rclone.conf <<EOF
        [gdrive]
        type = drive
        scope = drive
        service_account_file = /tmp/gdrive.json
        root_folder_id = ${GDRIVE_FOLDER_ID}
        EOF
        RUN_FOLDER="stock-reports-${{ github.run_id }}"
        rclone mkdir gdrive:"$RUN_FOLDER"
        rclone copy "reports" gdrive:"$RUN_FOLDER" --include "*.pdf" --fast-list
        FOLDER_ID=$(python - <<'PY'
        import json
        import subprocess
        import sys
        
        run_folder = "${RUN_FOLDER}"
        result = subprocess.run(
            ["rclone", "lsjson", "gdrive:", "--dirs", "--max-depth", "1"],
            capture_output=True, text=True, check=True
        )
        items = json.loads(result.stdout)
        for item in items:
            if item.get("Name") == run_folder and item.get("ID"):
                print(item["ID"])
                sys.exit(0)
        sys.exit(1)
        PY
        )
        if [ -z "$FOLDER_ID" ]; then
          echo "âŒ æ— æ³•è·å–Google Driveå­æ–‡ä»¶å¤¹ID"
          exit 1
        fi
        echo "DRIVE_FOLDER_NAME=$RUN_FOLDER" >> $GITHUB_OUTPUT
        echo "DRIVE_LINK=https://drive.google.com/drive/folders/${FOLDER_ID}" >> $GITHUB_OUTPUT
      id: upload_drive

    - name: å‘é€æŠ¥å‘Šåˆ° Telegram ğŸš€
      if: success()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: "âœ… Felixï¼Œæœºå™¨äººå·²å®Œæˆè‚¡ç¥¨åˆ†ææŠ¥å‘Š\nğŸ“ Google Drive æ–‡ä»¶å¤¹: ${{ steps.upload_drive.outputs.DRIVE_LINK }}\nğŸ“‚ å­æ–‡ä»¶å¤¹: ${{ steps.upload_drive.outputs.DRIVE_FOLDER_NAME }}"
