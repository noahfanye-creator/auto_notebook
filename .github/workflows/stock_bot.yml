name: è‚¡ç¥¨åˆ†ææœºå™¨äºº ğŸ¤–

on:
  schedule:
    # äº¤æ˜“æ—¥åˆç›˜ä¸æ”¶ç›˜ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
    # Aè‚¡ï¼š11:30 / 15:00ï¼›æ¸¯è‚¡ï¼š12:00 / 16:00
    # è§¦å‘æ—¶é—´åŠ  5 åˆ†é’Ÿç¼“å†²
    - cron: '35 3 * * 1-5'  # 11:35
    - cron: '5 4 * * 1-5'   # 12:05
    - cron: '5 7 * * 1-5'   # 15:05
    - cron: '10 8 * * 1-5'  # 16:10
  workflow_dispatch:
    inputs:
      stocks:
        description: 'è¾“å…¥è‚¡ç¥¨ä»£ç ï¼ˆæ”¯æŒAè‚¡å’Œæ¸¯è‚¡ï¼Œå¦‚ï¼š600460,00700ï¼‰'
        required: false
        default: '688630,600460,300474,300623,300019'

jobs:
  analyze-stocks:
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas numpy reportlab akshare matplotlib pytz yfinance
        sudo apt-get update
        sudo apt-get install -y fonts-wqy-zenhei
    
    - name: è¿è¡Œè‚¡ç¥¨åˆ†æ
      run: |
        export TZ='Asia/Shanghai'
        STOCKS="${{ github.event.inputs.stocks }}"
        if [ -z "$STOCKS" ]; then
          STOCKS="688630,600460,300474,300623,300019"
        fi
        # ä½¿ç”¨ manual æ¨¡å¼ï¼Œè¿™æ ·è„šæœ¬åªç®¡ç”Ÿæˆ PDFï¼Œä¸ä¼šæŠ¥é”™ä¹Ÿä¸ä¼šé‡å¤å‘æ¶ˆæ¯
        python github_stock_bot.py --mode manual --stocks "$STOCKS"
    
    - name: æ•´ç†æŠ¥å‘Šæ–‡ä»¶
      run: |
        mkdir -p final_delivery
        # ä½ çš„è„šæœ¬ä¼šç”Ÿæˆ reports/ æ–‡ä»¶å¤¹ï¼Œæˆ‘ä»¬æŠŠé‡Œé¢çš„ zip æ‰¾å‡ºæ¥
        find reports -name "*.zip" -exec cp {} final_delivery/stock_report.zip \;

    - name: ä¸Šä¼ æŠ¥å‘Šåˆ° GitHub Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: stock-reports-${{ github.run_id }}
        path: |
          final_delivery/stock_report.zip

    - name: å‘é€æŠ¥å‘Šåˆ° Telegram ğŸš€
      if: success()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        document: final_delivery/stock_report.zip
        caption: "âœ… Felixï¼Œæœºå™¨äººå·²å®Œæˆè‚¡ç¥¨åˆ†ææŠ¥å‘Šï¼ˆZIPï¼‰"
