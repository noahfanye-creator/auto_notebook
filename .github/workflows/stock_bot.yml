name: è‚¡ç¥¨åˆ†ææœºå™¨äºº ğŸ¤–

on:
  workflow_dispatch:
    inputs:
      stocks:
        description: 'è‚¡ç¥¨ä»£ç ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰'
        required: false
        default: '600460 300474 300623 300420'
        type: string
  schedule:
    # åŒ—äº¬æ—¶é—´å‘¨ä¸€è‡³å‘¨äº” 15:10 è‡ªåŠ¨è¿è¡Œä¸€æ¬¡
    - cron: '10 7 * * 1-5'

jobs:
  analyze-stocks:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas numpy reportlab akshare matplotlib pytz
        sudo apt-get update
        sudo apt-get install -y fonts-wqy-zenhei
    
    - name: è¿è¡Œè‚¡ç¥¨åˆ†æ
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        export TZ='Asia/Shanghai'
        # ä¿®æ­£æ–‡ä»¶åï¼šç¡®ä¿è¿è¡Œçš„æ˜¯ github_stock_bot.py
        # å¹¶ä¼ å…¥ä½ çš„ 4 æ”¯ç›®æ ‡è‚¡
        python github_stock_bot.py --mode telegram --stocks '${{ github.event.inputs.stocks }}'
    
    - name: ä¸Šä¼ æŠ¥å‘Šåˆ° GitHub (å¤‡ç”¨)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: stock-reports-${{ github.run_id }}
        path: |
          reports/**/*.pdf
          reports/**/*.zip

    - name: å‘é€æŠ¥å‘Šåˆ° Telegram ğŸš€
      if: success()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        document: reports/**/*.zip
        caption: "âœ… Felixï¼Œæœºå™¨äººå·²å®Œæˆ 4 æ”¯è‚¡ç¥¨æ·±åº¦åˆ†æï¼\nğŸ“ˆ ç›®æ ‡ï¼šå£«å…°å¾®ã€æ™¯å˜‰å¾®ã€æ·æ·å¾®ç”µã€äº”æ´‹è‡ªæ§\nğŸ“Š æŒ‡æ ‡ï¼šMACD, RSI, KDJ, å¨å»‰, OBV"
