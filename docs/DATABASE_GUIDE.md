# 本地数据库使用指南

## 概述

增强版本地数据库系统支持数据积累和快速查询。系统会：
- ✅ **优先从数据库读取**：查询时先检查本地数据库
- ✅ **只有成功返回的数据才写入**：确保数据质量
- ✅ **自动数据验证**：验证价格逻辑、成交量等
- ✅ **逐渐积累数据**：每次运行都会增加新的数据
- ✅ **支持市场指数缓存**：指数数据也会保存到数据库

## 数据库结构

### 表1: kline_by_scale（K线数据表）
存储个股的K线数据（日线、30分钟、5分钟、1分钟）

- `code`: 股票代码（如 sh600036）
- `scale`: K线周期（240=日线, 30=30分钟, 5=5分钟, 1=1分钟）
- `date`: 日期时间
- `open, high, low, close, volume`: OHLCV数据
- `created_at, updated_at`: 创建和更新时间

### 表2: meta_info（元数据表）
跟踪每个股票的数据状态

- `code`: 股票代码
- `stock_name`: 股票名称
- `market_type`: 市场类型（A股/港股）
- `last_update_date`: 最后更新日期
- `last_update_scale`: 最后更新的周期
- `data_count`: 数据条数
- `last_success_at`: 最后成功更新时间

### 表3: market_indices（市场指数数据表）
存储市场指数的K线数据

- `index_code`: 指数代码（如 sh000001）
- `index_name`: 指数名称
- `scale`: K线周期
- `date`: 日期
- `open, high, low, close, volume`: OHLCV数据

## 数据验证规则

只有通过以下验证的数据才会写入数据库：

1. ✅ 必需列存在：Date, Open, High, Low, Close, Volume
2. ✅ 价格数据有效：价格 > 0
3. ✅ 价格逻辑正确：High >= Low, High >= Open, High >= Close, Low <= Open, Low <= Close
4. ✅ 成交量有效：Volume >= 0
5. ✅ 日期唯一：无重复日期

## 使用方法

### 1. 启用数据库

在 `config/config.yaml` 中确保：

```yaml
database:
  enabled: true
  path: "data/stock_data.db"
```

### 2. 自动运行

数据库功能已集成到数据获取流程中，无需额外操作：

- 查询数据时，系统会**优先从数据库读取**
- 如果数据库数据足够新，直接返回，**不请求网络**
- 如果需要更新，请求网络数据
- **只有成功返回的有效数据才写入数据库**

### 3. 查看数据库统计

运行统计工具：

```bash
python3 scripts/db_stats.py
```

输出示例：
```
📊 本地数据库统计信息
📁 数据库路径: data/stock_data.db

📈 K线数据统计:
  总记录数: 15,234 条
  股票数量: 45 只

📊 市场指数数据统计:
  总记录数: 1,200 条
  指数数量: 8 个

💾 数据库大小: 2.45 MB

📋 最近更新的股票（前20只）:
...
```

## 工作流程

```
1. 查询数据
   ↓
2. 检查数据库
   ├─ 有数据且足够新 → 直接返回（快速）
   └─ 无数据或需要更新 → 请求网络
      ↓
3. 网络请求成功
   ↓
4. 数据验证
   ├─ 验证通过 → 写入数据库 ✅
   └─ 验证失败 → 不写入 ❌
```

## 优势

1. **速度提升**：优先从本地数据库读取，大幅提升查询速度
2. **数据质量**：只有成功返回的有效数据才写入
3. **逐渐积累**：每次运行都会增加新数据，数据库越来越丰富
4. **离线可用**：历史数据保存在本地，可离线使用
5. **降低接口压力**：减少网络请求次数

## 注意事项

1. 数据库文件保存在 `data/stock_data.db`，已添加到 `.gitignore`
2. 首次运行会创建数据库并开始积累数据
3. 数据验证失败不会影响主流程，只是不写入数据库
4. 技术指标（MACD、RSI等）是实时计算的，不存储在数据库中

## 维护

### 查看数据库内容

```python
from src.database import get_stock_db

db = get_stock_db()
if db:
    # 获取统计信息
    stats = db.get_stats()
    print(stats)
    
    # 查询某个股票的数据
    df = db.get_kline_data('sh600036', 240, limit=100)
    print(df)
```

### 清理数据库（谨慎操作）

如果需要清理数据库，可以删除 `data/stock_data.db` 文件，系统会在下次运行时重新创建。
